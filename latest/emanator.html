<!-- Emanator WebMIDI instrument built with Kasm Rust WASM SDK
Copyright (c) 2025 Pyrmont Brewery
Author: Kevin Staunton-Lambert
Version: 1.18.2 (Build: )

Go build similar instruments like this using Kasm Rust WASM SDK here:
https://pyrmontbrewery.com/get_kasm
-->
<html><head><title>KASM test harness</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"></head><body><h1>KASM WebMIDI test harness</h1><div style="margin: 20px 0;"><div style="margin: 10px 0; padding: 10px; background: #f9f9f9;">Connect to your MIDI device... (you might need a <a href="https://help.ableton.com/hc/en-us/articles/209774225-Setting-up-a-virtual-MIDI-bus" target="_blank">virtual MIDI bus</a>)<div style="margin-bottom: 10px;"><label><select id="midiOutputSelect" style="padding: 3px; margin-left: 10px;"><option value="">Select MIDI Device...</option></select></label> <button id="refreshMidiDevices" style="margin-left: 10px; padding: 3px 8px;">&lt;</button> <label>MIDI Channel: <select id="midiChannel" width="50" style="padding: 3px; width: 40px; margin-left: 20px;"><option value="0">1</option><option value="1">2</option><option value="2">3</option><option value="3">4</option><option value="4">5</option><option value="5">6</option><option value="6">7</option><option value="7">8</option><option value="8">9</option><option value="9">10</option><option value="10">11</option><option value="11">12</option><option value="12">13</option><option value="13">14</option><option value="14">15</option><option value="15">16</option></select></label> <button id="playMidi" style="padding: 5px 15px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">&gt;</button> <button id="stopMidi" style="padding: 5px 15px; background: #f44336; color: white; border: none; cursor: pointer; margin-left: 10px;">!</button> <span id="playbackStatus" style="margin-left: 15px; font-weight: bold;"></span></div></div><canvas id="kasmHTMLCanvas" width="600" height="150" style="width: 600px;
        height: 150px;
        border: 2px solid #333;
        background: #000;
        display: block;
        margin: 10px 0;"></canvas><div style="margin: 20px 0;"><div style="margin: 10px 0; padding: 10px; background: #f9f9f9;"><label>Choose an Emanator algorithm (inlet_5):<br><div style="margin-bottom: 10px;"><label><input type="radio" name="emanatorQuick" onclick='isRadioButtonSelection=!0,document.getElementById("inlet_5_emanator").value=2,autoTransform(),saveSettings(),kasm_rust&&kasm_rust.set_emanator&&kasm_rust.set_emanator(2)'> Emanator</label> <label><input type="radio" name="emanatorQuick" onclick='isRadioButtonSelection=!0,document.getElementById("inlet_5_emanator").value=63,autoTransform(),saveSettings(),kasm_rust&&kasm_rust.set_emanator&&kasm_rust.set_emanator(63)'> Looper</label> <label><input type="radio" name="emanatorQuick" onclick='isRadioButtonSelection=!0,document.getElementById("inlet_5_emanator").value=93,autoTransform(),saveSettings(),kasm_rust&&kasm_rust.set_emanator&&kasm_rust.set_emanator(93)'> Bangaz</label> <label><input type="radio" name="emanatorQuick" onclick='isRadioButtonSelection=!0,document.getElementById("inlet_5_emanator").value=164,autoTransform(),saveSettings(),kasm_rust&&kasm_rust.set_emanator&&kasm_rust.set_emanator(164)'> Arpeggiator</label> <label><input type="radio" name="emanatorQuick" onclick='isRadioButtonSelection=!0,document.getElementById("inlet_5_emanator").value=83,autoTransform(),saveSettings(),kasm_rust&&kasm_rust.set_emanator&&kasm_rust.set_emanator(83)'> Shuffle</label> <label><input type="radio" name="emanatorQuick" onclick='isRadioButtonSelection=!0,document.getElementById("inlet_5_emanator").value=148,autoTransform(),saveSettings(),kasm_rust&&kasm_rust.set_emanator&&kasm_rust.set_emanator(148)'> LFO</label> <label><input type="radio" name="emanatorQuick" onclick='isRadioButtonSelection=!0,document.getElementById("inlet_5_emanator").value=6,autoTransform(),saveSettings(),kasm_rust&&kasm_rust.set_emanator&&kasm_rust.set_emanator(6)'> Chords</label> <label><input type="radio" name="emanatorQuick" onclick='isRadioButtonSelection=!0,document.getElementById("inlet_5_emanator").value=252,autoTransform(),saveSettings(),kasm_rust&&kasm_rust.set_emanator&&kasm_rust.set_emanator(252)'> Orbit</label></div><button onclick="prevEmanator()" style="padding: 3px 8px; margin-right: 5px;">◀ Prev</button> <button onclick="nextEmanator()" style="padding: 3px 8px; margin-right: 10px;">Next ▶</button> <select id="inlet_5_emanator" onchange="autoTransform(),kasm_rust&&kasm_rust.set_emanator&&kasm_rust.set_emanator(parseInt(this.value))" style="padding: 3px;"><option value="0">Random</option><option value="1">mldy:Phone Ringtone Classic phone ringtone melody with humanization</option><option value="2">mldy:Strummed Cascade Cascading glissando with stereo spread</option><option value="3">mldy:Elaborate Panning Melodic patterns with dynamic panning</option><option value="4">mldy:Advanced Rhythmic Complex melodic patterns with rhythmic variations</option><option value="5">hmny:Chord Progression Classic chord progressions with well-known pattern</option><option value="6">hmny:Simple Chord Basic major triad chord</option><option value="7">hmny:Extended Inversions Extended chords with inversions</option><option value="8">hmny:Complex Extensions Complex chord progressions with extensions and rhy</option><option value="9">rhym:Morse Code Morse code patterns with rhythmic timing</option><option value="10">rhym:Markov Chain Markov chain-based rhythmic patterns</option><option value="11">rhym:Wave Interference Trigonometric wave interference patterns</option><option value="12">rhym:Complex Reflection Physics-based reflection algorithms</option><option value="13">rhym:Balkan 7/8 Balkan 7/8 rhythm (aksak)</option><option value="14">rhym:West African Bell West African bell pattern (12/8 cross-rhythm)</option><option value="15">rhym:Indian Tintal Indian Tintal (16-beat cycle)</option><option value="16">rhym:Latin son clave Latin son clave (3-2)</option><option value="17">rhym:Jazz Swing 8ths Jazz swing eighths</option><option value="18">rhym:Fibonacci rhythm Fibonacci rhythm (5, 8, 13, ...)</option><option value="19">rhym:Golden ratio pulse Golden ratio pulse</option><option value="20">rhym:Prime number rhythm Prime number rhythm</option><option value="21">rhym:Balkan 11/8 (3+2+3+3) Balkan 11/8 (3+2+3+3)</option><option value="22">rhym:Contemporary tuplets (5:4) Contemporary tuplets (5:4)</option><option value="23">rhym:Afro-Cuban 6/8 bell Afro-Cuban 6/8 bell</option><option value="24">prog:Circle of Fifths Circle of Fifths progression with modulation and p</option><option value="25">prog:Stepwise Progression Diatonic stepwise progression</option><option value="26">prog:Plagal Cadence IV-I plagal cadence</option><option value="27">prog:Deceptive Cadence V-vi deceptive cadence</option><option value="28">prog:Modal Mixture Modal mixture progression</option><option value="29">prog:Descending Fifths Descending fifths progression</option><option value="30">prog:Jazz Turnaround I-vi-ii-V jazz turnaround</option><option value="31">prog:Chromatic Mediant Chromatic mediant progression</option><option value="32">prog:Neapolitan Chord Neapolitan chord progression</option><option value="33">prog:Augmented Sixth Augmented sixth progression</option><option value="34">chnt:Chant Dorian Call-Response Call and response in Dorian mode (chant style)</option><option value="35">chnt:Chant Psalm Tone Gregorian psalm tone formula</option><option value="36">chnt:Chant Ornamented Response Responsorial echo with ornamentation</option><option value="37">chnt:Chant with Drone Responsorial chant with ison (drone)</option><option value="38">chnt:Chant Antiphonal Antiphonal (alternating) chant</option><option value="39">spat:Harmonic Resonance Harmonic series with spatial positioning</option><option value="40">spat:Swarm Movement Boids algorithm with spatial audio</option><option value="41">spat:Circular Panning Dynamic circular panning effects</option><option value="42">spat:3D Positioning Simulated 3D spatial positioning</option><option value="43">math:Fibonacci Spiral Fibonacci timing with golden ratio velocity decay</option><option value="44">math:Fractal Cascade Fractal echo patterns at different time scales</option><option value="45">math:Swarming Spirals Bumblebee flight patterns with Fibonacci timing</option><option value="46">math:Fractal Chaos L-systems, strange attractors, and chaos theory</option><option value="47">expr:Multidimensional Markov Multi-dimensional Markov chain with harmonic conte</option><option value="48">expr:Second Order Markov Second-order Markov chain with rhythm patterns</option><option value="49">expr:Chaos Game Harmony Chaos game algorithm for counterpoint harmony</option><option value="50">expr:Complex Drums Complex drum patterns using golden ratio mathemati</option><option value="51">expr:Cellular Automaton Cellular automaton melody generator (Rule 30)</option><option value="52">expr:Euclidean Rhythm Euclidean rhythm pattern generator</option><option value="53">expr:L-System L-system based melody generator</option><option value="54">expr:Microtonal 24-TET Microtonal melody generator using 24-TET</option><option value="55">expr:Brownian Walk Stochastic Brownian walk melody generator</option><option value="56">expr:Spectral Texture Spectral overtone texture generator</option><option value="57">expr:Shepard Tone Endless rising/falling pitch illusion with layered</option><option value="58">expr:Parameter Morphing Dynamic parameter morphing melody generator</option><option value="59">expr:Polymetric (3:4) Polymetric engine generating 3:4 patterns</option><option value="60">expr:Polytempo Engine Polytempo engine for variable speed patterns</option><option value="61">note:Krumhansl Arpeggiator</option><option value="62">note:Krumhansl Chords</option><option value="63">loop:Tape Loop Delay</option><option value="64">loop:Chaos Game Harmony Generates random harmony using chaos game logic an</option><option value="65">loop:Modular Arithmetic Harmony Cyclical pitch patterns using modular arithmetic.</option><option value="66">loop:Cellular Automata Harmony Binary sequence pitch offsets using Rule 30.</option><option value="67">loop:Spectral Harmony Harmony based on overtone series.</option><option value="68">loop:L-System Harmony Interval sequences generated by L-systems.</option><option value="69">loop:Markov Matrix Harmony Probabilistic interval jumps using Markov matrix.</option><option value="70">loop:Quasi-Crystal Harmony Penrose tiling angles for interval structure.</option><option value="71">loop:Fractal Brownian Harmony Fractal Brownian motion for pitch contour.</option><option value="72">loop:Hyperbolic Geometry Harmony Interval mapping using hyperbolic tangent.</option><option value="73">loop:Prime Spiral Harmony Pitch offsets using Ulam spiral of primes.</option><option value="74">loop:Fibonacci Harmony Counterpoint using Fibonacci intervals.</option><option value="75">loop:Markov Harmony Probabilistic note selection based on history.</option><option value="76">loop:Fractal Harmony Self-similar patterns at different octaves.</option><option value="77">loop:Prime Harmony Mathematically pure intervals using primes.</option><option value="78">loop:Golden Ratio Harmony Organic intervals using the golden ratio.</option><option value="79">Clear All Drum Assignments</option><option value="80">Reset Ableton Drum Rack Assignments</option><option value="81">Reset General MIDI Drums</option><option value="82">Reset Drums as Notes</option><option value="83">Shuffle Drum Assignments Around</option><option value="84">Reassign Kick (drum)</option><option value="85">Reassign Snare (drum)</option><option value="86">Reassign HHClose</option><option value="87">Reassign HHOpen</option><option value="88">Reassign LowTom (drum)</option><option value="89">Reassign MidTom (drum)</option><option value="90">Reassign HiTom (drum)</option><option value="91">Reassign Clap</option><option value="92">Reassign CowBell</option><option value="93">drum:Bangaz 1 Classic four-on-the-floor kick/snare with toms, en</option><option value="94">drum:Bangaz 2 Polyrhythmic pattern with triplet kicks, cross-rhy</option><option value="95">drum:Bangaz 3 Extravagant polyrhythms with displaced snares, acc</option><option value="96">drum:Bangaz 4 Evolving groove that changes every 4 bars, adding</option><option value="97">drum:Bangaz 5 Weirdly polyrhythmic pattern with quintuplet kicks</option><option value="98">drum:Bangaz 6 Evolving Euclidean rhythm generator with increasin</option><option value="99">drum:Bangaz 7 Complex velocity and pan using sine/cosine, with o</option><option value="100">drum:Bangaz 8 Wildly complex beat placement using golden ratio,</option><option value="101">drum:Bangaz 9 Bossa nova with dynamic pan, ghost notes, and tom</option><option value="102">drum:Bangaz 10 Classic 808 with swing, intricate math for all dru</option><option value="103">drum:Bangaz 11 909 shuffle with adjustable shuffle depth, all dru</option><option value="104">drum:Bangaz 12 LinnDrum pop groove with HH accent and snare ghost</option><option value="105">drum:Bangaz 13 Electro syncopation with pan and velocity modulati</option><option value="106">drum:Bangaz 14 808 cowbell funk with pan and HH swing, all drums,</option><option value="107">drum:Bangaz 15 707 disco with snare and open HH accents, all drum</option><option value="108">drum:Bangaz 16 606 breakbeat with tom and snare accent controls,</option><option value="109">drum:Bangaz 17 808 Miami bass with kick and clap accent controls,</option><option value="110">drum:Bangaz 18 727 Latin groove with cowbell and tom accent contr</option><option value="111">drum:Bangaz 19 808 triplet funk with triplet swing and snare acce</option><option value="112">drum:Bangaz 20 909 techno ride with ride and snare accent control</option><option value="113">drum:Bangaz 21 808 boogie with tom accent and HH swing, plus hats</option><option value="114">drum:Bangaz 22 707 house with clap and HH accent controls, plus k</option><option value="115">drum:Bangaz 23 808 clave pattern with offset and accent controls,</option><option value="116">drum:Bangaz 24 909 broken beat with snare ghost and tom accent, p</option><option value="117">drum:Bangaz 25 808 shuffle with swing and HH accent controls, plu</option><option value="118">drum:Bangaz 26 707 funk with snare and open HH accent controls, p</option><option value="119">drum:Bangaz 27 808 triplet shuffle with triplet swing and snare a</option><option value="120">drum:Bangaz 28 909 ride shuffle with ride accent and HH swing, pl</option><option value="121">drum:Bangaz 29 808 clave funk with clave offset and accent, plus</option><option value="122">drum:Bangaz 30 Classical Motown Swing - evolving, panned, modwhee</option><option value="123">drum:Bangaz 31 Classical Polyrhythmic Waltz with Mathematical Pan</option><option value="124">drum:Bangaz 32 R&B Shuffle with Complex Syncopation and CC1 Modul</option><option value="125">drum:Bangaz 33 Groove with Mathematical Fills</option><option value="126">drum:Bangaz 34 Jazz Swing with Complex Polyrhythms</option><option value="127">drum:Bangaz 35 Complex with Clave & Percussion</option><option value="128">drum:Bangaz 36 Electronic Breakbeat with Glitch Elements</option><option value="129">drum:Bangaz 37 Progressive Rock with Odd Time Signatures</option><option value="130">drum:Bangaz 38 Fusion Odd-Time with Complex Polyrhythms</option><option value="131">drum:Bangaz 39 Breakcore Chaos with Algorithmic Placement</option><option value="132">drum:Bangaz 40 Polyrhythmic with Full Percussion</option><option value="133">drum:Bangaz 41 Drum'n'Bass Complex with Algorithmic Breaks</option><option value="134">drum:Bangaz 42 Industrial Techno with Algorithmic Noise</option><option value="135">drum:Bangaz 43 Minimal Techno with Mathematical Precision</option><option value="136">drum:Bangaz 44 Samba Complex with Authentic Brazilian Rhythms</option><option value="137">drum:Bangaz 45 Dubstep with Complex Wobbles & Math Placement</option><option value="138">drum:Bangaz 46 Trap with Complex Hi-Hat Rolls & Math Snare</option><option value="139">drum:Bangaz 47 Reggaeton with Complex Dembow Latin Perc</option><option value="140">drum:Bangaz 48 Neurofunk with Complex Algorithmic Pattern</option><option value="141">drum:Bangaz 49 Footwork Juke with Rapid-Fire Math Patterns</option><option value="142">drum:Bangaz 50 Grime with UK Garage Syncopation</option><option value="143">drum:Bangaz 51 Psytrance with Math Sequences Full Arsenal</option><option value="144">drum:Bangaz 52 Hardstyle with Reverse Bass Maths Kick</option><option value="145">drum:Bangaz 53 Gabber with Extreme Speed Chaos</option><option value="146">drum:Bangaz 54 Ambient Dub Techno with Sparse Math Patterns</option><option value="147">drum:Bangaz 55 Experimental Polymetric with All DrumTypes</option><option value="148">lfo:LFO Sine Classic sine wave LFO with speed and phase control</option><option value="149">lfo:LFO Sawtooth Sawtooth wave LFO with speed and direction control</option><option value="150">lfo:LFO Square Square wave LFO with speed and pulse width control</option><option value="151">lfo:LFO Triangle Triangle wave LFO with speed and symmetry controls</option><option value="152">lfo:LFO Motown Fadeout Gradually decreasing until it disappears rather th</option><option value="153">lfo:LFO Cubic Cubic function (y=x³) LFO with intensity controls</option><option value="154">lfo:LFO Exponential Exponential function LFO with base controls</option><option value="155">lfo:LFO Logarithmic Logarithmic function LFO with scaling controls</option><option value="156">lfo:LFO Fibonacci Fibonacci sequence-based LFO with sequence length</option><option value="157">lfo:LFO Golden Ratio Golden ratio spiral LFO with spiral tightness cont</option><option value="158">lfo:LFO Chaos Logistic Chaotic logistic map LFO with chaos parameter cont</option><option value="159">lfo:LFO Prime Sequence Prime number sequence LFO with sequence length con</option><option value="160">lfo:LFO Mandelbrot Mandelbrot set escape time LFO with zoom control</option><option value="161">lfo:LFO Lorenz Curve Lorenz attractor chaotic system LFO with axis sele</option><option value="162">lfo:LFO Lissajous Lissajous curve LFO with frequency ratio control</option><option value="163">lfo:LFO Collatz Collatz conjecture LFO with starting number range</option><option value="164">arp:Up Classic ascending arpeggiator - plays held notes f</option><option value="165">arp:Down Classic descending arpeggiator - plays held notes</option><option value="166">arp:Up/Down Pendulum arpeggiator - ascends then descends witho</option><option value="167">arp:Down/Up Reverse pendulum arpeggiator - descends then ascen</option><option value="168">arp:Random Random arpeggiator - plays held notes in random or</option><option value="169">arp:Flow Flow arpeggiator - plays notes in the exact order</option><option value="170">arp:Up In Converging inward - alternates outer notes moving</option><option value="171">arp:Down In Converging inward from high - starts high and conv</option><option value="172">arp:Expanding Up Expanding outward from center with upward preferen</option><option value="173">arp:Expanding Down Expanding outward from center with downward prefer</option><option value="174">arp:Low and Up Alternates lowest note with ascending sequence (St</option><option value="175">arp:Low and Down Alternates lowest note with descending sequence (S</option><option value="176">arp:Hi and Up Alternates highest note with ascending sequence (S</option><option value="177">arp:Hi and Down Alternates highest note with descending sequence (</option><option value="178">arp:Chord Strum Plays all held notes simultaneously as a chord</option><option value="179">arp:Octave Spread Octave spreading - plays root note across multiple</option><option value="180">arp:UpDownRepeat Up and Down with Repeat</option><option value="181">arp:DownUpRepeat Down and Up with Repeat</option><option value="182">arp:DoubledUp Doubled Up</option><option value="183">arp:DoubledDown Doubled Down</option><option value="184">arp:Converge Converge</option><option value="185">arp:Diverge Diverge</option><option value="186">arp:ConvergeDiverge Converge and Diverge</option><option value="187">arp:ThumbUp Thumb Up</option><option value="188">arp:ThumbUpDown Thumb Up and Down</option><option value="189">arp:PinkyUp Pinky Up</option><option value="190">arp:PinkyUpDown Pinky Up and Down</option><option value="191">arp:CycleThirds Cycle Thirds</option><option value="192">arp:SkipOneUp Skip One Up</option><option value="193">arp:SkipOneDown Skip One Down</option><option value="194">arp:OuterToInner Outer to Inner</option><option value="195">arp:InnerToOuter Inner to Outer</option><option value="196">arp:ReverseFlow Reverse Flow</option><option value="197">arp:StaggeredUp Staggered Up</option><option value="198">arp:StaggeredDown Staggered Down</option><option value="199">arp:Bounce Bounce</option><option value="200">arp:RandomSkip Random Skip</option><option value="201">arp:ChordPulse Chord Pulse</option><option value="202">arp:OctaveJumpUp Octave Jump Up</option><option value="203">arp:OctaveJumpDown Octave Jump Down</option><option value="204">arp:SpiralUp Spiral Up</option><option value="205">arp:SpiralDown Spiral Down</option><option value="206">arp:DoubleBackUp Double Back Up</option><option value="207">arp:DoubleBackDown Double Back Down</option><option value="208">arp:MirrorUp Mirror Up</option><option value="209">arp:MirrorDown Mirror Down</option><option value="210">arp:RandomMirror Random Mirror</option><option value="211">arp:ZigZag Up Zigzag pattern ascending</option><option value="212">arp:ZigZag Down Zigzag pattern descending</option><option value="213">arp:ZigZag Up & Down Zigzag up and down</option><option value="214">arp:ZigZag Down & Up Zigzag down and up</option><option value="215">arp:Spiral In Spiral inward pattern</option><option value="216">arp:Spiral Out Spiral outward pattern</option><option value="217">arp:Spiral In & Out Spiral in and out</option><option value="218">arp:Spiral Out & In Spiral out and in</option><option value="219">arp:Pinky Down Pinky down pattern</option><option value="220">arp:Pinky Down & Up Pinky down and up</option><option value="221">arp:Thumb Down Thumb down pattern</option><option value="222">arp:Thumb Down & Up Thumb down and up</option><option value="223">arp:Random Octave Random octave jumps</option><option value="224">arp:Random Cycle Random cycle pattern</option><option value="225">arp:Random Cycle Octave Random cycle with octave jumps</option><option value="226">arp:MonoBassline Mono Bassline</option><option value="227">arp:ArcadeTrills Arcade Trills</option><option value="228">arp:BouncingFunk Bouncing Funk</option><option value="229">arp:Up 2 Oct Ascending 2 octaves</option><option value="230">arp:Down 2 Oct Descending 2 octaves</option><option value="231">arp:Alberti Bass Classical broken chord</option><option value="232">arp:Waltz Bass 3/4 time waltz pattern</option><option value="233">arp:Trill Major 2nd Major 2nd trill</option><option value="234">arp:Tremolo Classical tremolo</option><option value="235">arp:Harp Sweep Harp-like roll</option><option value="236">arp:Broken Octaves Classical octave pattern</option><option value="237">arp:Arpeggione Schubert-style</option><option value="238">arp:Thirds Parallel Parallel thirds</option><option value="240">phys:Bouncing Balls Simulates bouncing balls with stereo pan, triggeri</option><option value="241">phys:Pendulums Multiple pendulums with golden ratio lengths creat</option><option value="242">phys:Trampoline Balls bouncing on a trampoline, affecting each oth</option><option value="243">phys:Physics Tennis A ball hit back and forth with stereo positioning.</option><option value="244">phys:Euclidean Orbits Euclidean rhythms based on planetary orbits.</option><option value="245">phys:Wind Chimes Simulates wind chimes ringing in a breeze with ran</option><option value="246">phys:Wormhole Falling through the wormhole vortex</option><option value="247">phys:Transporter Beam me up Scotty!</option><option value="248">phys:Newton's Cradle Classic desk toy with endless momentum transfer be</option><option value="249">phys:Coupled Pendulums Spring-connected pendulums creating complex polyrh</option><option value="250">phys:Magnetic Spinner Frictionless magnetic levitation with prime-ratio</option><option value="251">phys:Water Wheel Self-filling water wheel paradox creating rhythmic</option><option value="252">phys:Orbital Resonance Planets in perfect gravitational harmony like Jupi</option><option value="253">phys:Precessing Gyroscope Eternal precession creating slowly evolving melodi</option><option value="254">phys:Fibonacci Spiral Golden ratio based endless sequence following natu</option><option value="255">phys:Lorenz Attractor Chaotic butterfly-shaped strange attractor generat</option><option value="256">phys:Double Pendulum Deterministic chaos generator with two coupled pen</option><option value="257">phys:Quantum Tunneling Probability-based oscillator tunneling between ene</option><option value="258">phys:Wave Interference Multiple wave sources creating complex interferenc</option><option value="259">phys:Harmonic Lattice Coupled spring-mass grid with wave propagation.</option><option value="260">phys:Brownian Motion Random walk melody with musical interval constrain</option><option value="261">phys:Soliton Wave Non-dispersive wave packets traveling without spre</option><option value="262">phys:Lissajous Curves Parametric oscillations with musical frequency rat</option><option value="263">phys:Resonant Cavity Standing wave patterns in a box triggering on reso</option><option value="264">phys:Doppler Shift Moving sound sources with pitch modulation and dis</option><option value="265">phys:Gravitational Slingshot Spacecraft performing orbital assist maneuvers aro</option><option value="266">phys:Cymatics Sound visualization patterns creating resonant mel</option><option value="267">phys:Plasma Oscillation Charged particle collective motion creating Langmu</option><option value="270">xprs:Fading Echo Notes repeat with decreasing velocity creating ech</option><option value="271">xprs:Rippling Waves Notes spread outward like ripples in water</option><option value="272">xprs:Trill Cascade Rapid trills that cascade up or down</option><option value="273">xprs:Ebb and Flow Notes swell and recede like ocean tides</option><option value="274">xprs:Ascending Spiral Notes spiral upward with increasing intensity</option><option value="275">xprs:Descending Cascade Notes cascade downward with fading intensity</option><option value="276">xprs:Velocity Surge Dramatic velocity crescendo and decrescendo</option><option value="277">xprs:Breath Swell Long notes with breath control creating swells</option><option value="278">xprs:Stereo Scatter Notes scattered across the stereo field</option><option value="279">xprs:Tremolo Pulse Rapid repeated notes with tremolo effect</option><option value="280">xprs:Harmonic Bloom Notes bloom outward in natural harmonics</option><option value="281">xprs:Melting Glissando Notes slide and melt into each other</option><option value="282">xprs:Rhythmic Fade Rhythmic pattern that fades in and out</option><option value="283">xprs:Octave Shimmer Notes shimmer across multiple octaves</option><option value="284">xprs:Pendulum Swing Notes swing back and forth like a pendulum</option><option value="285">xprs:Breathing Chord Chord that breathes with dynamic swells</option><option value="286">xprs:Staccato Burst Quick staccato bursts with velocity accents</option><option value="287">xprs:Wave Interference Two melodic waves that interfere and combine</option><option value="288">xprs:Crescendo Run Scale run with building crescendo</option><option value="289">xprs:Decrescendo Fall Falling notes with gentle decrescendo</option><option value="290">xprs:Ping Pong Delay Notes bounce between left and right channels</option><option value="291">xprs:Spiral Ascent Notes spiral upward with varied intervals</option><option value="292">xprs:Ripple Chord Chord notes ripple outward from center</option><option value="293">xprs:Velocity Waves Velocity undulates in continuous waves</option><option value="294">xprs:Morphing Melody Melody morphs between two patterns</option><option value="295">xprs:Harp Glissando Harp-like glissando sweeps</option><option value="296">xprs:Pulsing Drone Drone note with pulsing dynamics and fifth</option><option value="297">xprs:Fluttering Trill Fast flutter trill with dynamic variation</option><option value="298">xprs:Cascading Thirds Notes cascade in harmonious thirds</option><option value="299">xprs:Ethereal Wash Soft ethereal wash of overlapping notes</option><option value="300">evlv:Auto Fill Generator Generates random fills based on ratio timing</option><option value="301">evlv:Ghost Note Injector Adds subtle ghost notes to snare pattern</option><option value="302">evlv:Hi-Hat Densifier Hi-hat patterns become progressively busier</option><option value="303">evlv:Kick Variation Subtle kick timing and velocity variations</option><option value="304">evlv:Snare Ratchet Snare gets ratchets at ratio intervals</option><option value="305">evlv:Swing Evolver Pattern evolves from straight to swing timing</option><option value="306">evlv:Accent Shifter Accents move around the pattern over time</option><option value="307">evlv:Polyrhythm Layer Adds 3:2 or 5:4 polyrhythmic layers</option><option value="308">evlv:Break Inserter Inserts breaks and pauses at ratio intervals</option><option value="309">evlv:Humanize Drift Timing and velocity humanization grows over time</option><option value="310">evlv:Harmony Adder Adds 3rds, 5ths, and harmonies over time</option><option value="311">evlv:Octave Jumper Notes jump octaves and return to original</option><option value="312">evlv:Note Thinner Musical probability removes notes (root stays)</option><option value="313">evlv:Passing Tones Adds chromatic passing tones between notes</option><option value="314">evlv:Direction Flipper Arpeggio direction flips at ratio intervals</option><option value="315">evlv:Velocity Contour Velocity shape evolves over time</option><option value="316">evlv:Gate Breather Gate lengths breathe over time</option><option value="317">evlv:Chord Expander Single notes become chords over time</option><option value="318">evlv:Sequence Extender Pattern length grows over time</option><option value="319">evlv:Inversion Cycler Cycles through chord inversions</option><option value="320">evlv:Scale Morpher Morphs between different scales/modes</option><option value="321">evlv:Density Wave Note density ebbs and flows</option><option value="322">evlv:Interval Expander Intervals widen over time</option><option value="323">evlv:Rhythm Mutator Rhythmic cells mutate over time</option><option value="324">evlv:Call Response Develops antiphonal call-response patterns</option><option value="325">evlv:Tension Builder Builds tension to climax then releases</option><option value="326">evlv:Register Shift Pattern moves through registers</option><option value="327">evlv:Articulation Evolver Evolves from staccato to legato</option><option value="328">evlv:CC Sweep CC values sweep over time</option><option value="329">evlv:Pan Orbiter Stereo field rotates</option><option value="330">evlv:Fading Echo Notes fade with decreasing velocity</option><option value="331">evlv:Pitch Drift Echo notes drift in pitch</option><option value="332">evlv:Time Stretch Echo delays stretch or compress</option><option value="333">evlv:Reverse Echo Sequence reverses pattern over time</option><option value="334">evlv:Harmonic Echo Echoes add harmonies</option><option value="335">evlv:Stutter Effect Creates stutter at ratio intervals</option><option value="336">evlv:Filter Sweep Echo Filter sweeps on echoes via CC74</option><option value="337">evlv:Ping Pong Echo Pan alternates between left and right</option><option value="338">evlv:Granular Decay Notes fragment into grains over time</option><option value="339">evlv:Inversion Echo Each echo inverts around center pitch</option><option value="340">evlv:Circle of Fifths Progresses through circle of fifths</option><option value="341">evlv:Chaos to Order Starts random, converges to structured</option><option value="342">evlv:Generative Seed Evolving generative pattern from seed</option><option value="343">evlv:Breath Cycle Everything breathes together</option><option value="344">evlv:Climax Builder Builds intensity over 8 bars</option><option value="345">evlv:Minimalist Evolver Gradual phase shifting (Reich style)</option><option value="346">evlv:Jazz Improv Bebop-style variations</option><option value="347">evlv:Ambient Drift Slow ethereal evolution</option><option value="348">evlv:Funk Pocket Groove intensifies with fills</option><option value="349">evlv:Random Walk Brownian motion on all parameters</option><option value="350">evlv:I-IV-V-I Classic pop progression</option><option value="351">evlv:I-V-vi-IV Pop ballad progression</option><option value="352">evlv:ii-V-I Jazz standard progression</option><option value="353">evlv:I-vi-IV-V 50s Doo-Wop progression</option><option value="354">evlv:Axis I-IV-vi-V axis progression</option><option value="355">evlv:vi-IV-I-V Emotional pop progression</option><option value="356">evlv:Pachelbel Canon progression (I-V-vi-iii-IV-I-IV-V)</option><option value="357">evlv:Mixolydian I-bVII-IV-I rock progression</option><option value="358">evlv:Natural Minor i-bVI-bIII-bVII minor progression</option><option value="359">evlv:Blues Shuffle 12-bar blues progression</option><option value="360">evlv:Modern Jazz Pop I-V-vi-IV with 7th chords</option><option value="361">evlv:Minor Blues i-iv-V minor blues</option><option value="362">evlv:Modal Interchange I-III-IV-iv borrowed chords</option><option value="363">evlv:Neapolitan I-bII-I Neapolitan cadence</option><option value="364">evlv:Anthem Rock I-V-IV-V anthem progression</option><option value="365">evlv:Andalusian i-bVII-bVI-V flamenco cadence</option><option value="366">evlv:Rhythm Changes I-vi-ii-V jazz standard</option><option value="367">evlv:Sweet Child I-IV-bVII-IV rock pattern</option><option value="368">evlv:Harmonic Minor i-V-i-iv dramatic minor</option><option value="369">evlv:Extended Jazz I-iii-vi-ii-V-I full turnaround</option><option value="370">evlv:CoF Ascending Circle of fifths ascending majors</option><option value="371">evlv:CoF Descending Circle of fourths (descending 5ths)</option><option value="372">evlv:CoF ii-V ii-V through circle of fifths</option><option value="373">evlv:CoF Chromatic Chromatic approach through circle</option><option value="374">evlv:Coltrane Changes Giant Steps style major 3rd cycle</option><option value="-1">MIDI Pass Thru</option></select></label><br><label>Tempo (BPM): <input type="number" id="tempo" value="120" min="20" max="999" style="width: 100px;"></label></div></div><div style="margin: 20px 0;"><div style="margin: 10px 0; padding: 10px; background: #f9f9f9;"><div style="margin: 10px 0;"><div style="display: inline-block; margin: 10px; text-align: center;"><label>Root Note<br>(inlet_0):</label><br><div class="dial-container" style="position: relative; width: 60px; height: 60px; margin: 5px auto;"><svg width="60" height="60" class="dial-svg"><circle cx="30" cy="30" r="25" fill="none" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="25" fill="none" stroke="#0af" stroke-width="3" stroke-dasharray="157" stroke-dashoffset="157" id="note-progress" transform="rotate(-90 30 30)" stroke-linecap="round"/><line x1="30" y1="10" x2="30" y2="18" stroke="#0af" stroke-width="2" id="note-pointer" transform="rotate(0 30 30)"/></svg> <input type="range" id="note-dial" min="0" max="127" value="60" style="position: absolute; top: 0; left: 0; width: 60px; height: 60px; opacity: 0; cursor: pointer;" onchange='updateDial("note",this.value),updateNoteDisplay(),autoTransform()' oninput='updateDial("note",this.value),updateNoteDisplay(),autoTransform()'></div><div style="margin: 5px auto; width: 120px;"><input type="number" id="note" value="60" min="0" max="127" style="width: 60px; margin-right: 5px;" onchange='updateDial("note",this.value),updateNoteDisplay(),autoTransform()' oninput='updateDial("note",this.value),updateNoteDisplay(),autoTransform()'> <input type="text" id="noteName" value="C4" style="width: 45px; text-align: center; font-size: 12px; color: #666; padding: 2px;" onblur="updateNoteFromName()" onkeydown="handleNoteNameKeydown(event)" title="Type note name (e.g. C4, F#3, Bb5)"></div></div><div style="display: inline-block; margin: 10px; text-align: center;"><label id="inlet_1_label">Semitone offset<br>(inlet_1)</label><br><div class="dial-container" style="position: relative; width: 60px; height: 60px; margin: 5px auto;"><svg width="60" height="60" class="dial-svg"><circle cx="30" cy="30" r="25" fill="none" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="25" fill="none" stroke="#0af" stroke-width="3" stroke-dasharray="157" stroke-dashoffset="157" id="semitone-progress" transform="rotate(-90 30 30)" stroke-linecap="round"/><line x1="30" y1="10" x2="30" y2="18" stroke="#0af" stroke-width="2" id="semitone-pointer" transform="rotate(0 30 30)"/></svg> <input type="range" id="semitone-dial" min="-127" max="127" value="0" style="position: absolute; top: 0; left: 0; width: 60px; height: 60px; opacity: 0; cursor: pointer;" onchange='updateDial("semitone",this.value),autoTransform()' oninput='updateDial("semitone",this.value),autoTransform()'></div><input type="number" id="semitone" value="0" min="-127" max="127" style="width: 60px; text-align: center;" onchange='updateDial("Looper  Bangaz  Arpeggiator  Shuffle  Emanator  LFO  Taps  Counterpoint  Drum Rack  Chaos!  Resetsemitone",this.value),autoTransform()' oninput='updateDial("semitone",this.value),autoTransform()'></div><div style="display: inline-block; margin: 10px; text-align: center;"><label>Velocity<br>(inlet_2)</label><br><div class="dial-container" style="position: relative; width: 60px; height: 60px; margin: 5px auto;"><svg width="60" height="60" class="dial-svg"><circle cx="30" cy="30" r="25" fill="none" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="25" fill="none" stroke="#0af" stroke-width="3" stroke-dasharray="157" stroke-dashoffset="157" id="velocity-progress" transform="rotate(-90 30 30)" stroke-linecap="round"/><line x1="30" y1="10" x2="30" y2="18" stroke="#0af" stroke-width="2" id="velocity-pointer" transform="rotate(0 30 30)"/></svg> <input type="range" id="velocity-dial" min="0" max="127" value="100" style="position: absolute; top: 0; left: 0; width: 60px; height: 60px; opacity: 0; cursor: pointer;" onchange='updateDial("velocity",this.value),autoTransform()' oninput='updateDial("velocity",this.value),autoTransform()'></div><input type="number" id="velocity" value="100" min="0" max="127" style="width: 60px; text-align: center;" onchange='updateDial("velocity",this.value),autoTransform()' oninput='updateDial("velocity",this.value),autoTransform()'></div><div style="display: inline-block; margin: 10px; text-align: center;"><label>Enc1<br>(inlet_3)</label><br><div class="dial-container" style="position: relative; width: 60px; height: 60px; margin: 5px auto;"><svg width="60" height="60" class="dial-svg"><circle cx="30" cy="30" r="25" fill="none" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="25" fill="none" stroke="#0af" stroke-width="3" stroke-dasharray="157" stroke-dashoffset="157" id="enc1-progress" transform="rotate(-90 30 30)" stroke-linecap="round"/><line x1="30" y1="10" x2="30" y2="18" stroke="#0af" stroke-width="2" id="enc1-pointer" transform="rotate(0 30 30)"/></svg> <input type="range" id="enc1-dial" min="0" max="127" value="100" style="position: absolute; top: 0; left: 0; width: 60px; height: 60px; opacity: 0; cursor: pointer;" onchange='updateDial("enc1",this.value),autoTransform()' oninput='updateDial("enc1",this.value),autoTransform()'></div><input type="number" id="enc1" value="80" min="0" max="127" style="width: 60px; text-align: center;" onchange='updateDial("enc1",this.value),autoTransform()' oninput='updateDial("enc1",this.value),autoTransform()'></div><div style="display: inline-block; margin: 10px; text-align: center;"><label>Enc2<br>(inlet_4)</label><br><div class="dial-container" style="position: relative; width: 60px; height: 60px; margin: 5px auto;"><svg width="60" height="60" class="dial-svg"><circle cx="30" cy="30" r="25" fill="none" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="25" fill="none" stroke="#0af" stroke-width="3" stroke-dasharray="157" stroke-dashoffset="157" id="enc2-progress" transform="rotate(-90 30 30)" stroke-linecap="round"/><line x1="30" y1="10" x2="30" y2="18" stroke="#0af" stroke-width="2" id="enc2-pointer" transform="rotate(0 30 30)"/></svg> <input type="range" id="enc2-dial" min="0" max="127" value="50" style="position: absolute; top: 0; left: 0; width: 60px; height: 60px; opacity: 0; cursor: pointer;" onchange='updateDial("enc2",this.value),autoTransform()' oninput='updateDial("enc2",this.value),autoTransform()'></div><input type="number" id="enc2" value="50" min="0" max="127" style="width: 60px; text-align: center;" onchange='updateDial("enc2",this.value),autoTransform()' oninput='updateDial("enc2",this.value),autoTransform()'></div><div style="display: inline-block; margin: 10px; text-align: center;"><label>Rate<br>(ms)</label><br><div class="dial-container" style="position: relative; width: 60px; height: 60px; margin: 5px auto;"><svg width="60" height="60" class="dial-svg"><circle cx="30" cy="30" r="25" fill="none" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="25" fill="none" stroke="#0af" stroke-width="3" stroke-dasharray="157" stroke-dashoffset="157" id="rate-progress" transform="rotate(-90 30 30)" stroke-linecap="round"/><line x1="30" y1="10" x2="30" y2="18" stroke="#0af" stroke-width="2" id="rate-pointer" transform="rotate(0 30 30)"/></svg> <input type="range" id="rate-dial" min="30" max="1500" value="250" style="position: absolute; top: 0; left: 0; width: 60px; height: 60px; opacity: 0; cursor: pointer;" onchange='updateDial("rate",this.value),autoTransform()' oninput='updateDial("rate",this.value),autoTransform()'></div><input type="number" id="rateMs" value="250" min="30" max="1500" style="width: 60px; text-align: center;" onchange='updateDial("rate",this.value),autoTransform()' oninput='updateDial("rate",this.value),autoTransform()'></div><div style="display: inline-block; margin: 10px; text-align: center;"><label>Shared1<br>(inlet_7)</label><br><div class="dial-container" style="position: relative; width: 60px; height: 60px; margin: 5px auto;"><svg width="60" height="60" class="dial-svg"><circle cx="30" cy="30" r="25" fill="none" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="25" fill="none" stroke="#0af" stroke-width="3" stroke-dasharray="157" stroke-dashoffset="157" id="kasm_one-progress" transform="rotate(-90 30 30)" stroke-linecap="round"/><line x1="30" y1="10" x2="30" y2="18" stroke="#0af" stroke-width="2" id="kasm_one-pointer" transform="rotate(0 30 30)"/></svg> <input type="range" id="kasm_one-dial" min="0" max="179" value="0" style="position: absolute; top: 0; left: 0; width: 60px; height: 60px; opacity: 0; cursor: pointer;"></div><input type="number" id="kasm_one" value="0" min="0" max="179" style="width: 60px; text-align: center;" onchange='updateDial("kasm_one",this.value),autoTransform()' oninput='updateDial("kasm_one",this.value),autoTransform()'></div><div style="display: inline-block; margin: 10px; text-align: center;"><label>Shared2<br>(inlet_8)</label><br><div class="dial-container" style="position: relative; width: 60px; height: 60px; margin: 5px auto;"><svg width="60" height="60" class="dial-svg"><circle cx="30" cy="30" r="25" fill="none" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="25" fill="none" stroke="#0af" stroke-width="3" stroke-dasharray="157" stroke-dashoffset="157" id="kasm_two-progress" transform="rotate(-90 30 30)" stroke-linecap="round"/><line x1="30" y1="10" x2="30" y2="18" stroke="#0af" stroke-width="2" id="kasm_two-pointer" transform="rotate(0 30 30)"/></svg> <input type="range" id="kasm_two-dial" min="0" max="179" value="0" style="position: absolute; top: 0; left: 0; width: 60px; height: 60px; opacity: 0; cursor: pointer;"></div><input type="number" id="kasm_two" value="0" min="0" max="179" style="width: 60px; text-align: center;" onchange='updateDial("kasm_two",this.value),autoTransform()' oninput='updateDial("kasm_two",this.value),autoTransform()'></div><div style="margin-top: 10px; display: flex; align-items: center;"><label for="modwheel">Modwheel CC#1</label> <input type="range" id="modwheel" min="0" max="127" value="0" style="width: 120px; margin-right: 10px;"> <input type="number" id="modwheel-value" min="0" max="127" value="0" style="width: 50px; text-align: center; margin-right: 20px;"> <label for="pan">Pan CC#10</label> <input type="range" id="pan" min="0" max="127" value="64" style="width: 120px; margin-right: 10px;"> <input type="number" id="pan-value" min="0" max="127" value="64" style="width: 50px; text-align: center;"></div></div></div></div><div style="margin: 20px 0;"><div style="margin: 10px 0; padding: 10px; background: #f9f9f9;"><div id="kasmConfig"><label for="smooth_cc">Apply Rulez: Dials and Faders:</label> <select id="smooth_cc" onchange="updateKasmConfig.onclick()"><option value="Off">Off pass through CC changes as is</option><option value="SmoothSlow">SmoothSlow smooth CC changes</option></select> <label><input type="checkbox" id="ignore_scale" onchange="updateKasmConfig.onclick()"> Ignore Key/Scale</label> <label><input type="checkbox" id="hand_drums" onchange="updateKasmConfig.onclick()"> Hand Drums</label> <label><input type="checkbox" id="midiThruCheckbox" checked="checked"> MIDIThru</label> <button id="updateKasmConfig">&lt;</button></div></div></div><div id="chordKeyDetection" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div><div id="patternDetection" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div><button id="transformTest"></button><div style="margin-bottom: 20px;"><div id="midiKeyboard" style="border: 2px solid #333;
                background: #f0f0f0;
                height: 120px;
                width: 100%;
                position: relative;
                border-radius: 4px;
                overflow: hidden;"><svg id="keyboardSvg" width="100%" height="120" style="display: block;"><g id="whiteKeys"><rect x="0" y="0" width="60" height="120" fill="white" stroke="#333" stroke-width="1" data-note="0" data-key="a" class="piano-key white-key" rx="0" ry="0"/><text x="30" y="110" text-anchor="middle" font-size="12" fill="#666" pointer-events="none">C</text><text x="30" y="100" text-anchor="middle" font-size="10" fill="#999" pointer-events="none">a</text><rect x="60" y="0" width="60" height="120" fill="white" stroke="#333" stroke-width="1" data-note="2" data-key="s" class="piano-key white-key" rx="0" ry="0"/><text x="90" y="110" text-anchor="middle" font-size="12" fill="#666" pointer-events="none">D</text><text x="90" y="100" text-anchor="middle" font-size="10" fill="#999" pointer-events="none">s</text><rect x="120" y="0" width="60" height="120" fill="white" stroke="#333" stroke-width="1" data-note="4" data-key="d" class="piano-key white-key" rx="0" ry="0"/><text x="150" y="110" text-anchor="middle" font-size="12" fill="#666" pointer-events="none">E</text><text x="150" y="100" text-anchor="middle" font-size="10" fill="#999" pointer-events="none">d</text><rect x="180" y="0" width="60" height="120" fill="white" stroke="#333" stroke-width="1" data-note="5" data-key="f" class="piano-key white-key" rx="0" ry="0"/><text x="210" y="110" text-anchor="middle" font-size="12" fill="#666" pointer-events="none">F</text><text x="210" y="100" text-anchor="middle" font-size="10" fill="#999" pointer-events="none">f</text><rect x="240" y="0" width="60" height="120" fill="white" stroke="#333" stroke-width="1" data-note="7" data-key="g" class="piano-key white-key" rx="0" ry="0"/><text x="270" y="110" text-anchor="middle" font-size="12" fill="#666" pointer-events="none">G</text><text x="270" y="100" text-anchor="middle" font-size="10" fill="#999" pointer-events="none">g</text><rect x="300" y="0" width="60" height="120" fill="white" stroke="#333" stroke-width="1" data-note="9" data-key="h" class="piano-key white-key" rx="0" ry="0"/><text x="330" y="110" text-anchor="middle" font-size="12" fill="#666" pointer-events="none">A</text><text x="330" y="100" text-anchor="middle" font-size="10" fill="#999" pointer-events="none">h</text><rect x="360" y="0" width="60" height="120" fill="white" stroke="#333" stroke-width="1" data-note="11" data-key="j" class="piano-key white-key" rx="0" ry="0"/><text x="390" y="110" text-anchor="middle" font-size="12" fill="#666" pointer-events="none">B</text><text x="390" y="100" text-anchor="middle" font-size="10" fill="#999" pointer-events="none">j</text><rect x="420" y="0" width="60" height="120" fill="white" stroke="#333" stroke-width="1" data-note="12" data-key="k" class="piano-key white-key" rx="0" ry="0"/><text x="450" y="110" text-anchor="middle" font-size="12" fill="#666" pointer-events="none">C</text><text x="450" y="100" text-anchor="middle" font-size="10" fill="#999" pointer-events="none">k</text><rect x="480" y="0" width="60" height="120" fill="white" stroke="#333" stroke-width="1" data-note="14" data-key="l" class="piano-key white-key" rx="0" ry="0"/><text x="510" y="110" text-anchor="middle" font-size="12" fill="#666" pointer-events="none">D</text><text x="510" y="100" text-anchor="middle" font-size="10" fill="#999" pointer-events="none">l</text><rect x="540" y="0" width="60" height="120" fill="white" stroke="#333" stroke-width="1" data-note="16" data-key=";" class="piano-key white-key" rx="0" ry="0"/><text x="570" y="110" text-anchor="middle" font-size="12" fill="#666" pointer-events="none">E</text><text x="570" y="100" text-anchor="middle" font-size="10" fill="#999" pointer-events="none">;</text><rect x="600" y="0" width="60" height="120" fill="white" stroke="#333" stroke-width="1" data-note="17" data-key="'" class="piano-key white-key" rx="0" ry="0"/><text x="630" y="110" text-anchor="middle" font-size="12" fill="#666" pointer-events="none">F</text><text x="630" y="100" text-anchor="middle" font-size="10" fill="#999" pointer-events="none">'</text></g><g id="blackKeys"><rect x="40" y="0" width="40" height="80" fill="#333" stroke="#000" stroke-width="1" data-note="1" data-key="w" class="piano-key black-key" rx="0" ry="0"/><text x="60" y="70" text-anchor="middle" font-size="10" fill="white" pointer-events="none">C#</text><text x="60" y="60" text-anchor="middle" font-size="10" fill="#ccc" pointer-events="none">w</text><rect x="100" y="0" width="40" height="80" fill="#333" stroke="#000" stroke-width="1" data-note="3" data-key="e" class="piano-key black-key" rx="0" ry="0"/><text x="120" y="70" text-anchor="middle" font-size="10" fill="white" pointer-events="none">Eb</text><text x="120" y="60" text-anchor="middle" font-size="10" fill="#ccc" pointer-events="none">e</text><rect x="220" y="0" width="40" height="80" fill="#333" stroke="#000" stroke-width="1" data-note="6" data-key="t" class="piano-key black-key" rx="0" ry="0"/><text x="240" y="70" text-anchor="middle" font-size="10" fill="white" pointer-events="none">F#</text><text x="240" y="60" text-anchor="middle" font-size="10" fill="#ccc" pointer-events="none">t</text><rect x="280" y="0" width="40" height="80" fill="#333" stroke="#000" stroke-width="1" data-note="8" data-key="y" class="piano-key black-key" rx="0" ry="0"/><text x="300" y="70" text-anchor="middle" font-size="10" fill="white" pointer-events="none">G#</text><text x="300" y="60" text-anchor="middle" font-size="10" fill="#ccc" pointer-events="none">y</text><rect x="340" y="0" width="40" height="80" fill="#333" stroke="#000" stroke-width="1" data-note="10" data-key="u" class="piano-key black-key" rx="0" ry="0"/><text x="360" y="70" text-anchor="middle" font-size="10" fill="white" pointer-events="none">Bb</text><text x="360" y="60" text-anchor="middle" font-size="10" fill="#ccc" pointer-events="none">u</text><rect x="460" y="0" width="40" height="80" fill="#333" stroke="#000" stroke-width="1" data-note="13" data-key="o" class="piano-key black-key" rx="0" ry="0"/><text x="480" y="70" text-anchor="middle" font-size="10" fill="white" pointer-events="none">C#</text><text x="480" y="60" text-anchor="middle" font-size="10" fill="#ccc" pointer-events="none">o</text><rect x="520" y="0" width="40" height="80" fill="#333" stroke="#000" stroke-width="1" data-note="15" data-key="p" class="piano-key black-key" rx="0" ry="0"/><text x="540" y="70" text-anchor="middle" font-size="10" fill="white" pointer-events="none">Eb</text><text x="540" y="60" text-anchor="middle" font-size="10" fill="#ccc" pointer-events="none">p</text><rect x="640" y="0" width="40" height="80" fill="#333" stroke="#000" stroke-width="1" data-note="20" data-key="]" class="piano-key black-key" rx="0" ry="0"/><text x="660" y="70" text-anchor="middle" font-size="10" fill="white" pointer-events="none">F#</text><text x="660" y="60" text-anchor="middle" font-size="10" fill="#ccc" pointer-events="none">]</text></g></svg></div><div>KEYS: Play notes: a-' | Octave: z=down, x=up | Velocity: c=down, v=up</div></div><div style="margin-bottom: 20px;"><div id="midiClipView" style="border: 2px solid #333;
                background: #1a1a1a;
                height: 600px;
                width: 100%;
                position: relative;
                overflow-y: auto;
                overflow-x: hidden;
                border-radius: 4px;"><canvas id="midiCanvas" width="1600" height="1200" style="display: block;
                    width: 100%;
                    height: 100%;"></canvas></div></div><div style="margin: 20px 0;"><div style="margin: 10px 0; padding: 20px; background: #f9f9f9;"><label>Play some notes 'a-l=MIDI keys' z/x=octave c/v=velocity<br>or choose a sequence Ableton Notes dictionary (JSON)<div style="margin-bottom: 10px;"><select id="exampleSelect" style="padding: 5px; margin-right: 10px;" onchange="loadSelectedExample()"><option value="singleNote">Single Note</option><option value="send2notes">Two Notes</option><option value="send3notes">Three Notes</option><option value="twinkle_twinkle">Twinkle Twinkle</option><option value="three_blind_mice">Three Blind Mice</option><option value="ferer_jaques">Frère Jacques</option><option value="mary_little_lamb">Mary Had A Little Lamb</option><option value="happy_birthday">Happy Birthday</option><option value="happy_birthday_legatto">Happy Birthday (legatto)</option><option value="baa_baa">Baa Baa Sheep</option><option value="chord">Major Chord</option><option value="arpeggio">Arpeggio Sequence</option><option value="rhythmPattern">Rhythm Pattern</option><option value="pentatonicScale">Pentatonic Scale (5 notes)</option><option value="complexChord">Complex Chord (7 notes)</option><option value="bassline">Bassline Pattern (8 notes)</option><option value="melodicSequence">Melodic Sequence (10 notes)</option><option value="polyrhythm">Polyrhythm Pattern (12 notes)</option><option value="chromatic">Chromatic Run (12 notes)</option><option value="jazzChordProgression">Jazz Chord Progression (16 notes)</option><option value="complexArpeggio">Complex Arpeggio (20 notes)</option><option value="minimalistPattern">Minimalist Pattern (24 notes)</option><option value="orchestralStab">Orchestral Stab (32 notes)</option></select><br><textarea id="inputJson" rows="8" cols="80" style="font-family: monospace; font-size: 12px;" oninput="loadSelectedExample(),autoTransform()"></textarea></div></label></div></div><textarea id="outputJson" rows="40" cols="80" style="font-family: monospace; font-size: 12px;" readonly="readonly"></textarea><div id="loopDetection" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div><table style="border-collapse: collapse; width: 100%; margin: 10px 0; font-size: 12px;"><tbody><tr><td style="padding: 6px; font-weight: bold;">pitch</td><td style="padding: 6px;">The MIDI note number (e.g., 60 is Middle C, 90/100/103 are higher notes).</td></tr><tr style="background-color: #f9f9f9;"><td style="padding: 6px; font-weight: bold;">start_time</td><td style="padding: 6px;">When the note begins, in beats (relative to the clip's start).</td></tr><tr><td style="padding: 6px; font-weight: bold;">duration</td><td style="padding: 6px;">How long the note lasts, in beats.</td></tr><tr style="background-color: #f9f9f9;"><td style="padding: 6px; font-weight: bold;">velocity</td><td style="padding: 6px;">How hard the note is played (0–127): higher = louder.</td></tr><tr><td style="padding: 6px; font-weight: bold;">mute</td><td style="padding: 6px;">1 = muted note, 0 = active note.</td></tr><tr style="background-color: #f9f9f9;"><td style="padding: 6px; font-weight: bold;">probability</td><td style="padding: 6px;">A float between 0 and 1, showing the chance this note will play (1 = always, 0.5 = 50%).</td></tr><tr><td style="padding: 6px; font-weight: bold;">velocity_deviation</td><td style="padding: 6px;">Specifies variability in velocity for each triggering, often 0 unless randomization used.</td></tr><tr style="background-color: #f9f9f9;"><td style="padding: 6px; font-weight: bold;">release_velocity</td><td style="padding: 6px;">The velocity value sent when the note is released (key is lifted); often relevant for expressive playing.</td></tr></tbody></table></div><div id="result"></div><h2>Other tests...</h2><button id="runWasm1">Run kasm_midi_note_offset(MIDI Note C4 (60), +1)</button> <button id="runWasm2">Run kasm_midi_note_offset(MIDI Note C4 (60), -12)</button> <button id="runWasm3">Run kasm_midi_note_octave_hit(MIDI Note C4 (60), +12)</button><script></script><script>class KasmWebMIDI{constructor(t={}){this.options={enableMPE:!1!==t.enableMPE,logMIDI:!1===t.logMIDI,autoConnect:!1!==t.autoConnect,...t},this.midiAccess=null,this.midiOutputs=[],this.midiInputs=[],this.currentMidiOutput=null,this.playbackTimeouts=[],this.isPlaying=!1,this.mpeChannels=new Map,this.callbacks={onNoteOn:null,onNoteOff:null,onControlChange:null,onPitchBend:null,onDeviceStateChange:null,onMIDIReady:null,onError:null},this.initialize()}async initialize(){var t;if(this.log("Initializing WebMIDI support..."),!navigator.requestMIDIAccess)return this.log(t="WebMIDI API not supported in this browser","warn"),this.triggerCallback("onError",{type:"unsupported",message:"WebMIDI API not supported in this browser"}),!1;try{return this.log("Requesting MIDI access..."),this.midiAccess=await navigator.requestMIDIAccess({sysex:!1}),this.log("MIDI access granted successfully"),this.logMIDIDevices(),this.midiAccess.onstatechange=t=>{this.onMIDIStateChange(t),this.logMIDIDevices(),this.autoSelectSavedOutput&&this.autoSelectSavedOutput()},this.setupInputHandlers(),"function"==typeof this.retryEnumerateDevices&&this.retryEnumerateDevices(),this.log("MIDI system initialized successfully"),this.triggerCallback("onMIDIReady",{midiAccess:this.midiAccess}),!0}catch(t){return this.handleMIDIError(t),!1}}setupInputHandlers(){this.midiAccess&&this.midiAccess.inputs.forEach(t=>{this.setupInputMessageHandler(t)})}setupInputMessageHandler(t){t.onmidimessage=e=>{this.handleMIDIMessage(e,t.name,t.type)},this.log(`kasm: Message handler connected to INPUT device: "${t.name}"`)}handleMIDIMessage(t,e,i){var[s,t,n]=t.data,a=1+(15&s),o=240&s;if(s&&o){var l=void 0!==t?t:0,r=void 0!==n?n:0,h=(this.mpeChannels.has(a)||this.mpeChannels.set(a,{activeNotes:new Set,pitchBend:0,channelPressure:0,timbre:64,pressure:0}),this.mpeChannels.get(a));switch(this.logMIDIMessage(s,l,r,a,e,i,o),o){case 144:0<r?this.handleNoteOn(l,r,a,h):this.handleNoteOff(l,a,h);break;case 128:this.handleNoteOff(l,a,h);break;case 176:this.handleControlChange(l,r,a,h);break;case 224:this.handlePitchBend(l,r,a,h);break;case 208:this.handlePolyphonicAftertouch(l,r,a,h);break;case 192:this.log(`kasm: Program Change: ${l} - Channel: `+a);break;case 240:this.log("kasm: System message: 0x"+s.toString(16));break;default:this.log(`kasm: Other MIDI message: Type=0x${o.toString(16)}, Data1=${l}, Data2=${r} - Channel: `+a)}}}handleNoteOn(t,e,i,s){var n=this.getNoteName(t);this.log(`kasm: Note ON: ${n} (MIDI ${t}) - Velocity: ${e} - Channel: `+i),s.activeNotes.add(t),this.triggerCallback("onNoteOn",{pitch:t,velocity:e,channel:i,noteName:n,channelState:s})}handleNoteOff(t,e,i){var s=this.getNoteName(t);this.log(`kasm: Note OFF: ${s} (MIDI ${t}) - Channel: `+e),i.activeNotes.delete(t),this.triggerCallback("onNoteOff",{pitch:t,channel:e,noteName:s,channelState:i})}handleControlChange(t,e,i,s){this.log(`kasm: Control Change: CC${t} = ${e} - Channel: `+i),this.log("kasm: CC Name: "+this.getCCName(t)),74===t?(s.timbre=e,this.log(`kasm: MPE Timbre (Ch ${i}): `+e)):11===t&&(s.pressure=e,this.log(`kasm: MPE Pressure (Ch ${i}): `+e)),this.triggerCallback("onControlChange",{ccNumber:t,ccValue:e,channel:i,ccName:this.getCCName(t),channelState:s})}handlePitchBend(t,e,i,s){t=(e=e<<7|t)-8192,s.pitchBend=t,this.log(`kasm: Pitch Bend: ${e} (${0<t?"+":""}${t}) - Channel: `+i),this.triggerCallback("onPitchBend",{pitchBend:e,pitchBendCentered:t,channel:i,channelState:s})}handlePolyphonicAftertouch(t,e,i,s){var n=this.getNoteName(t);this.log(`kasm: Polyphonic Aftertouch: ${n} (MIDI ${t}) - Pressure: ${e} - Channel: `+i),0<(s.channelPressure=e)?this.handleNoteOn(t,e,i,s):this.handleNoteOff(t,i,s)}onMIDIStateChange(t){var e="input"===(t=t.port).type,i=e?"INPUT":"OUTPUT";this.log(`kasm: MIDI device state change: ${i} "${t.name}" - State: `+t.state),"connected"===t.state?e&&this.setupInputMessageHandler(t):"disconnected"===t.state&&!e&&this.currentMidiOutput&&this.currentMidiOutput.id===t.id&&(this.currentMidiOutput=null,this.log("Current MIDI output device was disconnected")),this.updateDeviceLists(),this.triggerCallback("onDeviceStateChange",{port:t,isInput:e,deviceType:i})}updateDeviceLists(){this.midiAccess&&(this.midiInputs=Array.from(this.midiAccess.inputs.values()),this.midiOutputs=Array.from(this.midiAccess.outputs.values()),this.log(`kasm: Updated device lists: ${this.midiInputs.length} inputs, ${this.midiOutputs.length} outputs`),this.updateMidiDeviceDropdown())}updateMidiDeviceDropdown(){if("undefined"!=typeof document){let t=document.getElementById("midiOutputSelect");t?(t.innerHTML="",this.midiOutputs.forEach((e,i)=>{var s=document.createElement("option");s.value=e.id,s.text=e.name||"Output "+(i+1),t.appendChild(s)}),this.log("MIDI output dropdown updated","info")):this.log("No MIDI output dropdown found in DOM","warn")}}populateDeviceSelect(t,e=null){var i,s;t&&(t.innerHTML='<option value="">Select MIDI Device...</option>',s=this.getInputDevices?this.getInputDevices():[],i=this.getOutputDevices?this.getOutputDevices():[],s.forEach((e,i)=>{var s=document.createElement("option");s.value="input-"+i,s.disabled=!0,s.style.color="#666",s.style.fontStyle="italic",i="connected"===e.state?"🟢":"🔴";s.textContent=i+` INPUT: ${e.name} (${e.manufacturer||"Unknown"}) - `+e.state,t.appendChild(s)}),0<s.length&&0<i.length&&((s=document.createElement("option")).disabled=!0,s.textContent="────────────────────────────",t.appendChild(s)),i.forEach(e=>{var i=document.createElement("option"),s=(i.value=e.id,"connected"===e.state?"🟩":"🟥");i.textContent=s+` OUTPUT: ${e.name} (${e.manufacturer||"Unknown"}) - `+e.state,"connected"===e.state?(i.style.color="#2e7d32",i.style.fontWeight="bold"):i.style.color="#d32f2f",t.appendChild(i)}),e)&&(s=i.find(t=>t.id===e))&&(t.value=s.id,this.currentMidiOutput=s)}getOutputDevices(){return this.updateDeviceLists(),this.midiOutputs}getInputDevices(){return this.updateDeviceLists(),this.midiInputs}selectOutputDevice(t){return 0<=t&&t<this.midiOutputs.length&&(this.currentMidiOutput=this.midiOutputs[t],this.log(`kasm: Selected MIDI output device: "${this.currentMidiOutput.name}"`),!0)}sendNoteOn(t,e,i=0){return this.currentMidiOutput?(this.currentMidiOutput.send([144+i,t,e]),this.log(`kasm: Sent Note On: pitch=${t}, velocity=${e}, channel=`+i),!0):(this.log("No MIDI output device selected","warn"),!1)}sendNoteOff(t,e=0,i=64){return this.currentMidiOutput?(this.currentMidiOutput.send([128+e,t,i]),this.log(`kasm: Sent Note Off: pitch=${t}, channel=`+e),!0):(this.log("No MIDI output device selected","warn"),!1)}sendControlChange(t,e,i=0){return this.currentMidiOutput?(this.currentMidiOutput.send([176+i,t,e]),this.log(`kasm: Sent CC: CC${t}=${e}, channel=`+i),!0):(this.log("No MIDI output device selected","warn"),!1)}sendAllNotesOff(t=0){if(!this.currentMidiOutput)return!1;this.currentMidiOutput.send([176+t,123,0]);for(let e=0;e<=127;e++)this.sendNoteOff(e,t);return this.log("kasm: Sent All Notes Off for channel "+t),!0}playMidiClip(t,e={}){if(!this.currentMidiOutput)return this.log("No MIDI output device selected","warn"),!1;this.stopPlayback();let{tempo:i=120,channel:s=0,loop:n=!1}=e,a=60/i*1e3;this.isPlaying=!0,this.log(`kasm: Starting MIDI clip playback with ${t.length} notes`),t.forEach(t=>{if(1!==t.mute&&!(t.probability<1&&Math.random()>t.probability)){var e=t.start_time*a,i=t.duration*a;let o=t.velocity;0<t.velocity_deviation&&(n=(2*Math.random()-1)*t.velocity_deviation,o=Math.max(1,Math.min(127,Math.round(t.velocity+n))));var n=setTimeout(()=>{this.isPlaying&&this.sendNoteOn(t.pitch,o,s)},e);n=(this.playbackTimeouts.push(n),setTimeout(()=>{this.isPlaying&&this.sendNoteOff(t.pitch,s,t.release_velocity||64)},e+i));this.playbackTimeouts.push(n)}});var o=Math.max(...t.map(t=>t.start_time+t.duration))*a+1e3;o=setTimeout(()=>{n&&this.isPlaying?this.playMidiClip(t,e):this.stopPlayback()},o);return this.playbackTimeouts.push(o),!0}stopPlayback(){this.isPlaying=!1,this.playbackTimeouts.forEach(t=>clearTimeout(t)),this.playbackTimeouts=[],this.sendAllNotesOff(),this.log("Stopped MIDI playback")}setCallback(t,e){this.callbacks.hasOwnProperty(t)?(this.callbacks[t]=e,this.log("kasm: Set callback for "+t)):this.log("kasm: Unknown callback event: "+t,"warn")}triggerCallback(t,e){var i=this.callbacks[t];if("function"==typeof i)try{i(e)}catch(e){this.log(`kasm: Error in ${t} callback: `+e.message,"error")}}logMIDIDevices(){this.midiAccess&&(this.midiOutputs=Array.from(this.midiAccess.outputs.values()),this.midiInputs=Array.from(this.midiAccess.inputs.values()),this.log(`kasm: Found ${this.midiOutputs.length} MIDI OUTPUT device(s):`),this.midiOutputs.forEach((t,e)=>{this.log(`kasm:   ${e+1}. OUTPUT: "${t.name}" (${t.manufacturer||"Unknown"}) - `+t.state)}),this.log(`kasm: Found ${this.midiInputs.length} MIDI INPUT device(s):`),this.midiInputs.forEach((t,e)=>{this.log(`kasm:   ${e+1}. INPUT: "${t.name}" (${t.manufacturer||"Unknown"}) - `+t.state)}),"function"==typeof this.callbacks.onDeviceStateChange)&&this.callbacks.onDeviceStateChange({type:"deviceListChanged",outputs:this.midiOutputs,inputs:this.midiInputs})}async retryEnumerateDevices(t=10,e=300){let i=0;for(;i<t;){if(await new Promise(t=>setTimeout(t,e)),this.log("Retrying MIDI device enumeration..."),this.logMIDIDevices(),this.setupInputHandlers(),0<this.midiOutputs.length){this.autoSelectSavedOutput&&this.autoSelectSavedOutput();break}i++}}autoSelectSavedOutput(){try{let e=localStorage.getItem("selectedMidiOutput");var t;e&&0<this.midiOutputs.length&&(t=this.midiOutputs.find(t=>t.id===e||t.name===e))&&(this.currentMidiOutput=t,this.log("Auto-reconnected to MIDI output: "+t.name),this.triggerCallback("onDeviceStateChange",{type:"autoReconnect",output:t}))}catch(t){this.log("Failed to auto-select saved MIDI output","warn")}}logMIDIMessage(t,e,i,s,n,a,o){this.options.logMIDI&&(this.log(`kasm: MIDI message from ${a.toUpperCase()} "${n}":`),this.log(`kasm:   Raw data: [${t}, ${e}, ${i}] (0x${t.toString(16)}, 0x${e.toString(16)}, 0x${i.toString(16)})`),this.log(`kasm:   Channel: ${s} `+(this.options.enableMPE?"(MPE enabled)":"")),this.log("kasm:   Message type: 0x"+o.toString(16)))}handleMIDIError(t){let e="MIDI access failed";"SecurityError"===t.name?e="MIDI access blocked by security policy":"NotSupportedError"===t.name?e="MIDI not supported on this system":"InvalidStateError"===t.name?e="MIDI system in invalid state":"AbortError"===t.name&&(e="MIDI access request was aborted"),this.log(`kasm: MIDI Error: ${e} - `+t.message,"error"),this.triggerCallback("onError",{type:"initialization",message:e,originalError:t})}getNoteName(t){var e=Math.floor(t/12)-1;return""+["C","C#","D","Eb","E","F","F#","G","G#","A","Bb","B"][t%12]+e}getCCName(t){return{0:"Bank Select MSB",1:"Modulation Wheel",2:"Breath Controller",4:"Foot Controller",5:"Portamento Time",6:"Data Entry MSB",7:"Channel Volume",8:"Balance",10:"Pan",11:"Expression Controller",64:"Sustain Pedal",65:"Portamento On/Off",66:"Sostenuto",67:"Soft Pedal",74:"Timbre/Brightness",120:"All Sound Off",121:"Reset All Controllers",123:"All Notes Off"}[t]||"CC "+t}log(t,e="info"){if(this.options.logMIDI)switch(e){case"error":console.error("kasm: "+t);break;case"warn":console.warn("kasm: "+t);break;default:console.log("kasm: "+t)}}getStatus(){return{initialized:!!this.midiAccess,inputDevices:this.midiInputs.length,outputDevices:this.midiOutputs.length,currentOutput:this.currentMidiOutput?.name||null,isPlaying:this.isPlaying,mpeEnabled:this.options.enableMPE}}}"undefined"!=typeof module&&module.exports?module.exports=KasmWebMIDI:"undefined"!=typeof window&&(window.KasmWebMIDI=KasmWebMIDI)</script></body><script>let kasm,kasmWebMIDI,autoTransformTimeout,autoPlayTimeout,autoOSCTimeout,inlet=0,currentMidiOutput=null,isRadioButtonSelection=!1;function post(e){console.log(`kasm: post: ${e}`)}function outlet_message(e,t){outlet(e,t,null)}function sendMidiData(e,t,i,o=!1){currentMidiOutput?currentMidiOutput.send(e):kasmWebMIDI&&kasmWebMIDI.currentMidiOutput&&kasmWebMIDI.currentMidiOutput.send(e),kasm_rust&&kasm_rust.update_canvas_data&&kasm_rust.update_canvas_data(t,i,o)}function outlet(e,t,i){if(0===e){const o=t,n=i,a=parseInt(document.getElementById("midiChannel").value)||0;if(currentMidiOutput)if(i&&n>0){highlightMidiNoteOnKeyboard(o,!0);sendMidiData([144+a,o,n],o,n),setTimeout(()=>{sendMidiData([128+a,o,0],o,0),highlightMidiNoteOnKeyboard(o,!1)},500)}else{highlightMidiNoteOnKeyboard(o,!1);sendMidiData([128+a,o,0],o,0)}else{if(kasmWebMIDI&&n>0){highlightMidiNoteOnKeyboard(o,!0);sendMidiData([144+a,o,n],o,n),setTimeout(()=>{sendMidiData([128+a,o,0],o,0),highlightMidiNoteOnKeyboard(o,!1)},500)}else if(kasmWebMIDI)highlightMidiNoteOnKeyboard(o,!1),kasmWebMIDI.sendNoteOff(o,a);else if(i&&n>0)highlightMidiNoteOnKeyboard(o,!0),setTimeout(()=>{highlightMidiNoteOnKeyboard(o,!1)},500);else{highlightMidiNoteOnKeyboard(o,!1);sendMidiData([128+a,o,0],o,0)}if(1===e){const e=t,o=i,n=parseInt(document.getElementById("midiChannel").value)||0;if(kasmWebMIDI&&"number"==typeof e&&"number"==typeof o){if(kasmWebMIDI.sendControlChange(e,o,n),10===e){const e=document.getElementById("pan"),t=document.getElementById("pan-value");e&&t&&(e.value=o,t.value=o)}if(1===e){const e=document.getElementById("modwheel"),t=document.getElementById("modwheel-value");e&&t&&(e.value=o,t.value=o)}}}if(0===e){const e=t,o=i,n=parseInt(document.getElementById("midiChannel").value)||0;kasmWebMIDI&&o>0?(highlightMidiNoteOnKeyboard(e,!0),kasmWebMIDI.sendNoteOn(e,o,n),setTimeout(()=>{kasmWebMIDI.sendNoteOff(e,n),highlightMidiNoteOnKeyboard(e,!1)},500)):kasmWebMIDI?(highlightMidiNoteOnKeyboard(e,!1),kasmWebMIDI.sendNoteOff(e,n)):i&&o>0?(highlightMidiNoteOnKeyboard(e,!0),setTimeout(()=>{highlightMidiNoteOnKeyboard(e,!1)},500)):highlightMidiNoteOnKeyboard(e,!1)}i&&n>0?(highlightMidiNoteOnKeyboard(o,!0),setTimeout(()=>{highlightMidiNoteOnKeyboard(o,!1)},500)):highlightMidiNoteOnKeyboard(o,!1)}}if(1===e&&(currentMidiOutput||kasmWebMIDI)){const e=t,o=i,n=parseInt(document.getElementById("midiChannel").value)||0;if("number"==typeof e&&"number"==typeof o){if(sendMidiData([176+n,e,o],e,o,!0),10===e){const e=document.getElementById("pan"),t=document.getElementById("pan-value");e&&t&&(e.value=o,t.value=o)}if(1===e){const e=document.getElementById("modwheel"),t=document.getElementById("modwheel-value");e&&t&&(e.value=o,t.value=o)}}}if(3===e){const e=document.getElementById("chordKeyDetection");e&&(e.innerHTML=`${t}`)}if(4===e){const e=document.getElementById("patternDetection");e&&(e.innerHTML=`${t}`)}if(5===e){const e=document.getElementById("loopDetection");e&&(e.innerHTML=`${t}`),updateMidiClipView(t)}}function run_test1(){inlet=0,msg_int(60),inlet=1,msg_int(1);const e=kasm_rust.kasm_midi_note_offset(inlet_0,inlet_1);document.getElementById("result").textContent="Result (C4 (60) kasm_midi_note_offset up 1 semitone): "+e+" (should be 61)"}function run_test2(){inlet=0,msg_int(60),inlet=1,msg_int(-12);const e=kasm_rust.kasm_midi_note_offset(inlet_0,inlet_1);document.getElementById("result").textContent="Result (C4 (60) kasm_midi_note_offset down 1 octave): "+e+" (should be 48)"}function run_test3(){inlet=0,msg_int(60),inlet=1,msg_int(12);const e=kasm_rust.kasm_midi_note_octave_hit(inlet_0,inlet_1);document.getElementById("result").textContent="Result (C4 (60) kasm_midi_note_octave_hit): "+e+" (should be 84)"}document.getElementById("runWasm1").addEventListener("click",run_test1),document.getElementById("runWasm2").addEventListener("click",run_test2),document.getElementById("runWasm3").addEventListener("click",run_test3);let midikeys_note=60,midikeys_semitone_or_cc=0,midikeys_semitone_or_cc_offset=0,midikeys_velocity=100,activeKeys=new Set,encodersChanged=!0;const keyboardMapping={a:0,w:1,s:2,e:3,d:4,f:5,t:6,g:7,y:8,h:9,u:10,j:11,k:12,o:13,l:14,p:15,";":16,"'":17,"]":18,"\\":20};function run_test_keyboard(){inlet=0,msg_int(midikeys_note),inlet=2,msg_int(midikeys_velocity),encodersChanged&&(encodersChanged=!1,inlet=1,msg_int(midikeys_semitone_or_cc+midikeys_semitone_or_cc_offset),inlet=3,msg_int(document.getElementById("enc1").value),inlet=4,msg_int(document.getElementById("enc2").value),inlet=5,msg_int(document.getElementById("inlet_5_emanator").value),inlet=7,msg_int(document.getElementById("kasm_one").value),inlet=8,msg_int(document.getElementById("kasm_two").value))}function initializeKasmWebMIDI(){console.log("kasm: Initializing WebMIDI with new module..."),kasmWebMIDI=new KasmWebMIDI({enableMPE:!0,logMIDI:!1,autoConnect:!0}),kasmWebMIDI.setCallback("onMIDIReady",e=>{console.log("kasm: WebMIDI ready"),updateMidiDeviceList(),document.getElementById("playbackStatus").textContent="MIDI ready"}),kasmWebMIDI.setCallback("onError",e=>{console.error("kasm: WebMIDI error:",e.message),document.getElementById("playbackStatus").textContent=e.message}),kasmWebMIDI.setCallback("onNoteOn",e=>{processNoteEvent(e.pitch,e.velocity),highlightMidiNoteOnKeyboard(e.pitch,!0)}),kasmWebMIDI.setCallback("onNoteOff",e=>{processNoteEvent(e.pitch,0),highlightMidiNoteOnKeyboard(e.pitch,!1)}),kasmWebMIDI.setCallback("onControlChange",e=>{1===e.ccNumber?updateModwheelUI(e.ccValue):10===e.ccNumber&&updatePanUI(e.ccValue)}),kasmWebMIDI.setCallback("onDeviceStateChange",e=>{console.log("kasm: Device state changed:",e),updateMidiDeviceList()}),kasm.kasmOSC(document.getElementById("kasm_one")),kasm.kasmOSC(document.getElementById("kasm_two"))}function updateMidiDeviceList(){console.log("kasm: Updating MIDI device list with new module...");const e=document.getElementById("midiOutputSelect"),t=e.value;if(e.innerHTML='<option value="">Select MIDI Device...</option>',!kasmWebMIDI)return void(document.getElementById("playbackStatus").textContent="WebMIDI not initialized");const i=kasmWebMIDI.getInputDevices(),o=kasmWebMIDI.getOutputDevices();if(console.log(`kasm: Found ${i.length} inputs, ${o.length} outputs`),i.forEach((t,i)=>{const o=document.createElement("option");o.value=`input-${i}`,o.disabled=!0,o.style.color="#666",o.style.fontStyle="italic";const n="connected"===t.state?"🟢":"🔴";o.textContent=`${n} INPUT: ${t.name} (${t.manufacturer||"Unknown"}) - ${t.state}`,e.appendChild(o)}),i.length>0&&o.length>0){const t=document.createElement("option");t.disabled=!0,t.textContent="────────────────────────────",e.appendChild(t)}o.forEach((t,i)=>{const o=document.createElement("option");o.value=i;const n="connected"===t.state?"🟩":"🟥";o.textContent=`${n} OUTPUT: ${t.name} (${t.manufacturer||"Unknown"}) - ${t.state}`,"connected"===t.state?(o.style.color="#2e7d32",o.style.fontWeight="bold"):o.style.color="#d32f2f",e.appendChild(o)}),t&&""!==t&&o[t]&&(e.value=t,selectMidiDevice());0===i.length+o.length?document.getElementById("playbackStatus").textContent="No MIDI devices found":0===o.length?document.getElementById("playbackStatus").textContent=`${i.length} input(s) found, no outputs`:document.getElementById("playbackStatus").textContent=`${o.length} output(s) available`}function selectMidiDevice(){const e=document.getElementById("midiOutputSelect").value;""!==e&&kasmWebMIDI?kasmWebMIDI.selectOutputDevice(e)?(currentMidiOutput=kasmWebMIDI.currentMidiOutput,document.getElementById("playbackStatus").textContent="ok"):(currentMidiOutput=null,document.getElementById("playbackStatus").textContent="Failed to select device"):(currentMidiOutput=null,document.getElementById("playbackStatus").textContent="No device selected")}function playMidiClip(){if(kasmWebMIDI&&kasmWebMIDI.currentMidiOutput)try{const e=document.getElementById("outputJson").value,t=JSON.parse(e).notes||[];if(0===t.length)return void(document.getElementById("playbackStatus").textContent="connected");const i=parseInt(document.getElementById("tempo").value)||120,o=parseInt(document.getElementById("midiChannel").value)||0;kasmWebMIDI.playMidiClip(t,{tempo:i,channel:o,loop:!1})&&(document.getElementById("playbackStatus").textContent="...",document.getElementById("playMidi").disabled=!0,setTimeout(()=>{document.getElementById("playMidi").disabled=!1,"..."===document.getElementById("playbackStatus").textContent&&(document.getElementById("playbackStatus").textContent="")},5e3))}catch(e){console.error("kasm: Error playing MIDI clip:",e),document.getElementById("playbackStatus").textContent="Error playing clip"}else document.getElementById("playbackStatus").textContent="No MIDI device selected"}function stopMidiPlayback(){kasmWebMIDI&&kasmWebMIDI.stopPlayback(),document.getElementById("playMidi").disabled=!1,"..."===document.getElementById("playbackStatus").textContent&&(document.getElementById("playbackStatus").textContent="Stopped")}function sendNoteOn(e,t,i=0){if(!currentMidiOutput)return;const o=Object.keys(keyboardMapping).find(t=>60+keyboardMapping[t]+midikeys_semitone_or_cc===e);if(o){const e=document.querySelector(`[data-key="${o}"]`);e&&e.setAttribute("fill","lime")}try{const e=bang(inlet_0,inlet_1,inlet_2,inlet_3,inlet_4,inlet_5,inlet_6,inlet_7,inlet_8);document.getElementById("result").textContent="Keyboard test result: "+e}catch(e){console.error("kasm: Error in run_test_keyboard:",e),document.getElementById("result").textContent="Error: "+e.message}}function sendNoteOff(e,t=0,i=64){if(!currentMidiOutput)return;const o=[128+t,e,i];currentMidiOutput.send(o);const n=Object.keys(keyboardMapping).find(t=>60+keyboardMapping[t]+midikeys_semitone_or_cc===e);if(n){const e=document.querySelector(`[data-key="${n}"]`);e&&(e.classList.contains("white-key")?(e.setAttribute("fill","white"),e.setAttribute("stroke","#333"),e.setAttribute("stroke-width","1")):(e.setAttribute("fill","#333"),e.setAttribute("stroke","#000"),e.setAttribute("stroke-width","1")))}try{const e=bang(inlet_0,inlet_1,0,inlet_3,inlet_4,inlet_5,inlet_6,inlet_7,inlet_8);document.getElementById("result").textContent="Keyboard test result: "+e}catch(e){console.error("kasm: Error in run_test_keyboard:",e),document.getElementById("result").textContent="Error: "+e.message}}function sendAllNotesOff(e=0){if(!currentMidiOutput)return;const t=[176+e,123,0];currentMidiOutput.send(t);for(let t=0;t<=127;t++)sendNoteOff(t,e)}function handleKeyDown(e){const t=e.key.toLowerCase(),i=document.activeElement;if(!(i&&"TEXTAREA"===i.tagName||e.ctrlKey||e.altKey||e.metaKey||e.shiftKey||activeKeys.has(t))){if(activeKeys.add(t),keyboardMapping.hasOwnProperty(t)){midikeys_note=60+keyboardMapping[t]+midikeys_semitone_or_cc,midikeys_note=Math.max(0,Math.min(127,midikeys_note)),midikeys_velocity=Math.max(1,parseInt(document.getElementById("velocity").value)||100),processNoteEvent(midikeys_note,midikeys_velocity);const e=parseInt(document.getElementById("midiChannel").value)||0;return void(currentMidiOutput?sendNoteOn(midikeys_note,midikeys_velocity,e):kasmWebMIDI&&kasmWebMIDI.currentMidiOutput&&kasmWebMIDI.sendNoteOn(midikeys_note,midikeys_velocity,e))}if("z"===t)return encodersChanged=!0,midikeys_semitone_or_cc=Math.max(-120,midikeys_semitone_or_cc-12),document.getElementById("semitone").value=midikeys_semitone_or_cc,updateDial("semitone",midikeys_semitone_or_cc),void console.log(`kasm: Octave down: semitone offset = ${midikeys_semitone_or_cc}`);if("x"===t)return encodersChanged=!0,midikeys_semitone_or_cc=Math.min(120,midikeys_semitone_or_cc+12),document.getElementById("semitone").value=midikeys_semitone_or_cc,updateDial("semitone",midikeys_semitone_or_cc),void console.log(`kasm: Octave up: semitone offset = ${midikeys_semitone_or_cc}`);if("c"===t){encodersChanged=!0;let e=parseInt(document.getElementById("velocity").value)||100;return e=Math.max(1,e-10),document.getElementById("velocity").value=e,updateDial("velocity",e),void console.log(`kasm: Velocity down: ${e}`)}if("v"===t){encodersChanged=!0;let e=parseInt(document.getElementById("velocity").value)||100;return e=Math.min(127,e+10),document.getElementById("velocity").value=e,updateDial("velocity",e),void console.log(`kasm: Velocity up: ${e}`)}}}function handleKeyUp(e){const t=e.key.toLowerCase();if(activeKeys.delete(t),keyboardMapping.hasOwnProperty(t)){const e=60+keyboardMapping[t]+midikeys_semitone_or_cc,i=Math.max(0,Math.min(127,e));midikeys_velocity=0,midikeys_note=i,run_test_keyboard();const o=parseInt(document.getElementById("midiChannel").value)||0;currentMidiOutput?sendNoteOff(i,o):currentMidiOutput&&kasmWebMIDI.sendNoteOff(i,o)}}function displayKeyboardHelp(){console.log("\nKeyboard Controls:\nNotes: A=C, W=C#, S=D, E=Eb, D=E, F=F, T=F#, G=G, Y=G#, H=A, U=Bb, J=B\nOctave: Z=down (-12), X=up (+12)\nVelocity: C=down (-10), V=up (+10)\n        ")}function loadSelectedExample(){let e;switch(document.getElementById("exampleSelect").value){case"singleNote":e=JSON.stringify({notes:[{note_id:1,pitch:60,start_time:0,duration:1,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"send2notes":e=JSON.stringify({notes:[{note_id:1,pitch:64,start_time:.25,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:69,start_time:.75,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"send3notes":e=JSON.stringify({notes:[{note_id:1,pitch:64,start_time:.25,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:69,start_time:.75,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:3,pitch:65,start_time:1.25,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"twinkle_twinkle":e=JSON.stringify({notes:[{note_id:1,pitch:72,start_time:0,duration:.845624947968698,velocity:53,mute:0,probability:1,velocity_deviation:0,release_velocity:89},{note_id:2,pitch:72,start_time:.996750124875125,duration:.855124823093573,velocity:62,mute:0,probability:1,velocity_deviation:0,release_velocity:72},{note_id:3,pitch:79,start_time:1.846999875124875,duration:.691458541458541,velocity:52,mute:0,probability:1,velocity_deviation:0,release_velocity:87},{note_id:4,pitch:79,start_time:2.858000072843823,duration:.682874937562438,velocity:52,mute:0,probability:1,velocity_deviation:0,release_velocity:80},{note_id:5,pitch:81,start_time:3.863874927156177,duration:.732875197718948,velocity:53,mute:0,probability:1,velocity_deviation:0,release_velocity:76},{note_id:6,pitch:81,start_time:4.815291739510489,duration:.682749802281052,velocity:75,mute:0,probability:1,velocity_deviation:0,release_velocity:83},{note_id:7,pitch:79,start_time:5.866833426989677,duration:1.967291562604063,velocity:73,mute:0,probability:1,velocity_deviation:0,release_velocity:87}]},null,2);break;case"three_blind_mice":e=JSON.stringify({notes:[{note_id:1,pitch:76,start_time:.320916583416583,duration:.938000020812521,velocity:81,mute:0,probability:1,velocity_deviation:0,release_velocity:87},{note_id:2,pitch:74,start_time:1.423166677072927,duration:.682833312520812,velocity:74,mute:0,probability:1,velocity_deviation:0,release_velocity:84},{note_id:3,pitch:72,start_time:2.457874937562437,duration:1.515250114468864,velocity:73,mute:0,probability:1,velocity_deviation:0,release_velocity:91},{note_id:4,pitch:76,start_time:4.64375,duration:.665999885531136,velocity:92,mute:0,probability:1,velocity_deviation:0,release_velocity:89},{note_id:5,pitch:74,start_time:5.741249895937396,duration:.783500093656344,velocity:88,mute:0,probability:1,velocity_deviation:0,release_velocity:69},{note_id:6,pitch:72,start_time:6.772291770729271,duration:1.326958198051948,velocity:78,mute:0,probability:1,velocity_deviation:0,release_velocity:84}]},null,2);break;case"ferer_jaques":e=JSON.stringify({notes:[{note_id:1,pitch:72,start_time:0,duration:1.082708437395937,velocity:90,mute:0,probability:1,velocity_deviation:0,release_velocity:88},{note_id:2,pitch:74,start_time:.972999916749917,duration:.973208302114552,velocity:89,mute:0,probability:1,velocity_deviation:0,release_velocity:82},{note_id:3,pitch:76,start_time:1.861999979187479,duration:1.056750020812521,velocity:92,mute:0,probability:1,velocity_deviation:0,release_velocity:76},{note_id:4,pitch:72,start_time:2.876208426989677,duration:.201124916749917,velocity:82,mute:0,probability:1,velocity_deviation:0,release_velocity:97},{note_id:5,pitch:72,start_time:3.936749968781219,duration:1.022375020812521,velocity:92,mute:0,probability:1,velocity_deviation:0,release_velocity:79},{note_id:6,pitch:74,start_time:4.886833218864469,duration:1.003166885198135,velocity:92,mute:0,probability:1,velocity_deviation:0,release_velocity:90},{note_id:7,pitch:76,start_time:5.826374927156177,duration:1.05641676032301,velocity:89,mute:0,probability:1,velocity_deviation:0,release_velocity:86},{note_id:8,pitch:72,start_time:6.848583447802198,duration:.318874875124875,velocity:89,mute:0,probability:1,velocity_deviation:0,release_velocity:90}]},null,2);break;case"mary_little_lamb":e=JSON.stringify({notes:[{note_id:1,pitch:52,start_time:1.154499927156177,duration:.616875052031302,velocity:97,mute:0,probability:1,velocity_deviation:0,release_velocity:91},{note_id:2,pitch:50,start_time:1.744833291708292,duration:.588624916749917,velocity:92,mute:0,probability:1,velocity_deviation:0,release_velocity:83},{note_id:3,pitch:48,start_time:2.303499885531135,duration:.566958562271062,velocity:89,mute:0,probability:1,velocity_deviation:0,release_velocity:77},{note_id:4,pitch:50,start_time:2.836458333333333,duration:.561458333333333,velocity:89,mute:0,probability:1,velocity_deviation:0,release_velocity:78},{note_id:5,pitch:52,start_time:3.407791687479187,duration:.260041520979021,velocity:94,mute:0,probability:1,velocity_deviation:0,release_velocity:83},{note_id:6,pitch:52,start_time:3.907208416583416,duration:.23099998959374,velocity:92,mute:0,probability:1,velocity_deviation:0,release_velocity:91},{note_id:7,pitch:52,start_time:4.440250114468864,duration:.419208135614386,velocity:92,mute:0,probability:1,velocity_deviation:0,release_velocity:96}]},null,2);break;case"happy_birthday":e=JSON.stringify({notes:[{note_id:1,pitch:60,start_time:1.223791573010323,duration:.24974998959374,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:60,start_time:1.940333364552115,duration:.24095826048951,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:3,pitch:62,start_time:2.727333343739594,duration:.204833447802198,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:4,pitch:60,start_time:3.998291552197802,duration:.270333572677323,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:5,pitch:65,start_time:5.151583312520812,duration:.302916614635365,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:6,pitch:64,start_time:6.423999958374958,duration:.202416593822844,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"happy_birthday_legatto":e=JSON.stringify({notes:[{notes:[{note_id:7,pitch:96,start_time:0,duration:.347999916749917,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:80},{note_id:8,pitch:96,start_time:.549499979187479,duration:.846833374958375,velocity:92,mute:0,probability:1,velocity_deviation:0,release_velocity:83},{note_id:9,pitch:98,start_time:1.286291573010323,duration:1.032208416583417,velocity:119,mute:0,probability:1,velocity_deviation:0,release_velocity:82},{note_id:10,pitch:96,start_time:2.279999947968698,duration:.81241674991675,velocity:111,mute:0,probability:1,velocity_deviation:0,release_velocity:46},{note_id:11,pitch:101,start_time:3.207124906343656,duration:.674666739510489,velocity:121,mute:0,probability:1,velocity_deviation:0,release_velocity:87},{note_id:12,pitch:100,start_time:4.183500353812854,duration:1.005083198051948,velocity:127,mute:0,probability:1,velocity_deviation:0,release_velocity:93}]}]},null,2);break;case"baa_baa":e=JSON.stringify({notes:[{note_id:1,pitch:72,start_time:.08470826048951,duration:.812625135281385,velocity:82,mute:0,probability:1,velocity_deviation:0,release_velocity:94},{note_id:2,pitch:72,start_time:1.053083374958375,duration:.733583343739594,velocity:89,mute:0,probability:1,velocity_deviation:0,release_velocity:83},{note_id:3,pitch:79,start_time:1.773208302114552,duration:.905791604229104,velocity:74,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:4,pitch:79,start_time:2.678999906343656,duration:.922208520646021,velocity:48,mute:0,probability:1,velocity_deviation:0,release_velocity:81},{note_id:5,pitch:81,start_time:3.5625,duration:.613916552197802,velocity:111,mute:0,probability:1,velocity_deviation:0,release_velocity:67},{note_id:6,pitch:83,start_time:3.945791708291708,duration:.61283326048951,velocity:94,mute:0,probability:1,velocity_deviation:0,release_velocity:79},{note_id:7,pitch:84,start_time:4.457708437395937,duration:.373374802281052,velocity:107,mute:0,probability:1,velocity_deviation:0,release_velocity:94},{note_id:8,pitch:81,start_time:4.836166697885448,duration:.524583229270729,velocity:107,mute:0,probability:1,velocity_deviation:0,release_velocity:92},{note_id:9,pitch:79,start_time:5.29695825008325,duration:1.15583348942724,velocity:103,mute:0,probability:1,velocity_deviation:0,release_velocity:87},{note_id:10,pitch:77,start_time:7.110875062437563,duration:.582541677072927,velocity:102,mute:0,probability:1,velocity_deviation:0,release_velocity:92},{note_id:11,pitch:77,start_time:7.966208270895771,duration:.670208437395937,velocity:92,mute:0,probability:1,velocity_deviation:0,release_velocity:87},{note_id:12,pitch:76,start_time:8.804499927156177,duration:.561708343739594,velocity:97,mute:0,probability:1,velocity_deviation:0,release_velocity:85},{note_id:13,pitch:76,start_time:9.584333374958375,duration:.674416729104229,velocity:87,mute:0,probability:1,velocity_deviation:0,release_velocity:81},{note_id:14,pitch:74,start_time:10.426791697885449,duration:.76233323967699,velocity:82,mute:0,probability:1,velocity_deviation:0,release_velocity:90},{note_id:15,pitch:74,start_time:11.374125093656344,duration:.716499906343656,velocity:83,mute:0,probability:1,velocity_deviation:0,release_velocity:87},{note_id:16,pitch:72,start_time:12.383958229270728,duration:1.711958354145854,velocity:75,mute:0,probability:1,velocity_deviation:0,release_velocity:93}]},null,2);break;case"chord":e=JSON.stringify({notes:[{note_id:1,pitch:60,start_time:0,duration:1,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:64,start_time:0,duration:1,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:3,pitch:67,start_time:0,duration:1,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"arpeggio":e=JSON.stringify({notes:[{note_id:1,pitch:60,start_time:0,duration:.5,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:64,start_time:.5,duration:.5,velocity:90,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:3,pitch:67,start_time:1,duration:.5,velocity:80,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:4,pitch:72,start_time:1.5,duration:.5,velocity:110,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"rhythmPattern":e=JSON.stringify({notes:[{note_id:1,pitch:60,start_time:0,duration:.25,velocity:120,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:60,start_time:.5,duration:.125,velocity:80,mute:0,probability:.8,velocity_deviation:10,release_velocity:64},{note_id:3,pitch:60,start_time:.75,duration:.125,velocity:60,mute:0,probability:.6,velocity_deviation:5,release_velocity:64},{note_id:4,pitch:60,start_time:1,duration:.5,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"pentatonicScale":e=JSON.stringify({notes:[{note_id:1,pitch:60,start_time:0,duration:.5,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:62,start_time:.5,duration:.5,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:3,pitch:64,start_time:1,duration:.5,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:4,pitch:67,start_time:1.5,duration:.5,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:5,pitch:69,start_time:2,duration:.5,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"complexChord":e=JSON.stringify({notes:[{note_id:1,pitch:60,start_time:0,duration:2,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:64,start_time:0,duration:2,velocity:95,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:3,pitch:67,start_time:0,duration:2,velocity:90,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:4,pitch:71,start_time:0,duration:2,velocity:85,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:5,pitch:74,start_time:0,duration:2,velocity:80,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:6,pitch:78,start_time:0,duration:2,velocity:75,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:7,pitch:81,start_time:0,duration:2,velocity:70,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"bassline":e=JSON.stringify({notes:[{note_id:1,pitch:48,start_time:0,duration:.5,velocity:110,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:50,start_time:.5,duration:.5,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:3,pitch:53,start_time:1,duration:.5,velocity:105,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:4,pitch:55,start_time:1.5,duration:.5,velocity:95,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:5,pitch:58,start_time:2,duration:.5,velocity:110,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:6,pitch:60,start_time:2.5,duration:.5,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:7,pitch:63,start_time:3,duration:.5,velocity:105,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:8,pitch:65,start_time:3.5,duration:.5,velocity:95,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"melodicSequence":e=JSON.stringify({notes:[{note_id:1,pitch:60,start_time:0,duration:.4,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:62,start_time:.4,duration:.4,velocity:105,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:3,pitch:64,start_time:.8,duration:.4,velocity:110,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:4,pitch:65,start_time:1.2,duration:.4,velocity:115,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:5,pitch:67,start_time:1.6,duration:.4,velocity:120,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:6,pitch:69,start_time:2,duration:.4,velocity:115,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:7,pitch:71,start_time:2.4,duration:.4,velocity:110,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:8,pitch:72,start_time:2.8,duration:.4,velocity:105,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:9,pitch:74,start_time:3.2,duration:.4,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:10,pitch:76,start_time:3.6,duration:.4,velocity:95,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"polyrhythm":e=JSON.stringify({notes:[{note_id:1,pitch:60,start_time:0,duration:.33,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:67,start_time:0,duration:.5,velocity:80,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:3,pitch:60,start_time:.33,duration:.33,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:4,pitch:67,start_time:.5,duration:.5,velocity:80,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:5,pitch:60,start_time:.66,duration:.33,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:6,pitch:67,start_time:1,duration:.5,velocity:80,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:7,pitch:60,start_time:1,duration:.33,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:8,pitch:60,start_time:1.33,duration:.33,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:9,pitch:67,start_time:1.5,duration:.5,velocity:80,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:10,pitch:60,start_time:1.66,duration:.33,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:11,pitch:67,start_time:2,duration:.5,velocity:80,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:12,pitch:60,start_time:2,duration:.33,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"chromatic":e=JSON.stringify({notes:[{note_id:1,pitch:60,start_time:0,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:61,start_time:.25,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:3,pitch:62,start_time:.5,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:4,pitch:63,start_time:.75,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:5,pitch:64,start_time:1,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:5,pitch:65,start_time:1.25,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:7,pitch:66,start_time:1.5,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:8,pitch:67,start_time:1.75,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:9,pitch:68,start_time:2,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:10,pitch:69,start_time:2.25,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:11,pitch:70,start_time:2.5,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:12,pitch:71,start_time:2.75,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"jazzChordProgression":e=JSON.stringify({notes:[{note_id:1,pitch:60,start_time:0,duration:1,velocity:90,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:64,start_time:0,duration:1,velocity:85,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:3,pitch:67,start_time:0,duration:1,velocity:80,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:4,pitch:70,start_time:0,duration:1,velocity:75,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:5,pitch:65,start_time:1,duration:1,velocity:90,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:6,pitch:69,start_time:1,duration:1,velocity:85,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:7,pitch:72,start_time:1,duration:1,velocity:80,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:8,pitch:75,start_time:1,duration:1,velocity:75,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:9,pitch:62,start_time:2,duration:1,velocity:90,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:10,pitch:66,start_time:2,duration:1,velocity:85,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:11,pitch:69,start_time:2,duration:1,velocity:80,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:12,pitch:73,start_time:2,duration:1,velocity:75,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:13,pitch:67,start_time:3,duration:1,velocity:90,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:14,pitch:71,start_time:3,duration:1,velocity:85,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:15,pitch:74,start_time:3,duration:1,velocity:80,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:16,pitch:77,start_time:3,duration:1,velocity:75,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;case"complexArpeggio":e=JSON.stringify({notes:[{note_id:1,pitch:48,start_time:0,duration:.125,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:2,pitch:52,start_time:.125,duration:.125,velocity:95,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:3,pitch:55,start_time:.25,duration:.125,velocity:90,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:4,pitch:60,start_time:.375,duration:.125,velocity:85,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:5,pitch:64,start_time:.5,duration:.125,velocity:80,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:6,pitch:67,start_time:.625,duration:.125,velocity:85,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:7,pitch:72,start_time:.75,duration:.125,velocity:90,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:8,pitch:76,start_time:.875,duration:.125,velocity:95,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:9,pitch:79,start_time:1,duration:.125,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:10,pitch:84,start_time:1.125,duration:.125,velocity:105,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:11,pitch:88,start_time:1.25,duration:.125,velocity:110,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:12,pitch:91,start_time:1.375,duration:.125,velocity:115,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:13,pitch:96,start_time:1.5,duration:.125,velocity:120,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:14,pitch:91,start_time:1.625,duration:.125,velocity:115,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:15,pitch:88,start_time:1.75,duration:.125,velocity:110,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:16,pitch:84,start_time:1.875,duration:.125,velocity:105,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:17,pitch:79,start_time:2,duration:.125,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:18,pitch:76,start_time:2.125,duration:.125,velocity:95,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:19,pitch:72,start_time:2.25,duration:.125,velocity:90,mute:0,probability:1,velocity_deviation:0,release_velocity:64},{note_id:20,pitch:67,start_time:2.375,duration:.125,velocity:85,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);break;default:e=""}document.getElementById("inputJson").value=e,autoTransform()}function loadDefaultExample(){const e=JSON.stringify({notes:[{note_id:1,pitch:64,start_time:.25,duration:.25,velocity:100,mute:0,probability:1,velocity_deviation:0,release_velocity:64}]},null,2);document.getElementById("inputJson").value=e,document.getElementById("rateMs").value=250,document.getElementById("note").value=60,updateDial("note",document.getElementById("note").value),document.getElementById("semitone").value=0,updateDial("semitone",document.getElementById("semitone").value),document.getElementById("velocity").value=100,updateDial("velocity",document.getElementById("velocity").value),document.getElementById("enc1").value=100,updateDial("enc1",document.getElementById("enc1").value),document.getElementById("enc2").value=80,updateDial("enc2",document.getElementById("enc2").value),document.getElementById("inlet_5_emanator").value=0,document.getElementById("tempo").value=120,document.getElementById("exampleSelect").value="singleNote",saveSettings(),autoTransform()}function initializeKasmCanvas(){if(kasm_rust&&kasm_rust.init_kasm_canvas)try{const e=document.getElementById("kasmHTMLCanvas");e&&("function"==typeof kasm_rust.set_canvas_element&&(kasm_rust.set_canvas_element(e),console.log("kasm: Canvas element cached in WASM")),"function"==typeof kasm_rust.init_kasm_canvas?(kasm_rust.init_kasm_canvas(e.width,e.height),console.log("kasm: HTML5 canvas initialized successfully width="+e.width+" height="+e.height)):console.warn("kasm: init_kasm_canvas function not available"))}catch(e){console.error("kasm: Failed to initialize HTML5 canvas:",e)}else console.warn("kasm: HTML5 feature missing")}function initializeApplication(){loadSettings()||loadDefaultExample(),kasm=new Kasm,initializeDials(),initializeNoteDisplay(),initializeMIDI(),initializeKasmWebMIDI(),initializePianoKeyboard(),setTimeout(initializeKasmCanvas,100),setTimeout(autoTransform,200),loadSelectedExample()}function drawMidiClip(e){const t=document.getElementById("midiCanvas"),i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const o=t.width,n=t.height,a=e.notes||[];if(0===a.length)return void clearMidiClip();let l=127,c=0,s=0;a.forEach(e=>{e.pitch<l&&(l=e.pitch),e.pitch>c&&(c=e.pitch);const t=e.start_time+e.duration;t>s&&(s=t)});const d=Math.max(6,Math.ceil(.1*(c-l))),r=Math.max(0,l-d),u=Math.min(127,c+d),m=u-r;s=Math.max(s,2);s+=.1*s,drawGrid(i,o,n,s,r,u),a.forEach(e=>{drawNote(i,e,o,n,s,r,m)}),drawLabels(i,o,n,s,r,u),drawZoomInfo(i,o,n,r,u,l,c)}function drawGrid(e,t,i,o,n,a){e.strokeStyle="#333",e.lineWidth=1;for(let n=0;n<=o;n+=.25){const a=n/o*t;e.beginPath(),e.moveTo(a,0),e.lineTo(a,i),e.stroke()}for(let o=n;o<=a;o+=12){const l=i-(o-n)/(a-n)*i;e.beginPath(),e.moveTo(0,l),e.lineTo(t,l),e.stroke()}}function drawNote(e,t,i,o,n,a,l){const c=t.start_time/n*i,s=t.duration/n*i,d=o-(t.pitch-a)/l*o,r=o/l*.8,u=t.velocity/127,m=240-240*u,y=20+u,v=10+50*u;if(e.fillStyle=`hsl(${m}, ${y}%, ${v}%)`,e.fillRect(c,d-r/2,Math.max(s,2),r),e.strokeStyle=`hsl(${m}, ${y}%, ${v+20}%)`,e.lineWidth=1,e.strokeRect(c,d-r/2,Math.max(s,2),r),s>2){const i=(e=>{const t=Math.floor(e/12)-1;return["C","C#","D","Eb","E","F","F#","G","G#","A","Bb","B"][e%12]+t})(t.pitch);e.fillStyle="#fff",e.font="18px Arial",e.fillText(`${i} (${t.pitch}) @${t.velocity}`,c+8,d+4)}}function drawLabels(e,t,i,o,n,a){e.fillStyle="#888",e.font="9px Arial";for(let n=0;n<=o;n+=.5){const a=n/o*t;e.fillText(`${n.toFixed(1)}s`,a+2,i-5)}const l=["C","C#","D","Eb","E","F","F#","G","G#","A","Bb","B"];for(let t=0;t<=a;t+=12){const o=i-(t-n)/(a-n)*i,c=Math.floor(t/12)-1,s=l[t%12];e.fillStyle="#aaa",e.font="bold 10px Arial",e.fillText(`${s}${c} (${t})`,5,o+4)}e.fillStyle="#666",e.font="8px Arial";const c=i/(a-n);if(c>8)for(let t=n;t<=a;t++)if(t%12!=0){const o=i-(t-n)/(a-n)*i,s=Math.floor(t/12)-1,d=l[t%12],r=[1,3,6,8,10];[0,2,4,5,7,9,11].includes(t%12)?e.fillText(`${d}${s} (${t})`,65,o+3):r.includes(t%12)&&c>12&&(e.fillStyle="#555",e.fillText(`${d}${s} (${t})`,65,o+3),e.fillStyle="#666")}}function clearMidiClip(){const e=document.getElementById("midiCanvas"),t=e.getContext("2d");t.clearRect(0,0,e.width,e.height);const i=e.width,o=e.height/2;t.fillStyle="#222",t.fillRect(0,o-20,i,40)}function drawZoomInfo(e,t,i,o,n,a,l){e.fillStyle="#999",e.font="11px Arial",e.textAlign="right";const c=["C","C#","D","Eb","E","F","F#","G","G#","A","Bb","B"];function s(e){const t=Math.floor(e/12)-1;return c[e%12]+t}s(o),s(n),s(a),s(l);e.textAlign="left"}function prevEmanator(){const e=document.getElementById("inlet_5_emanator");e.selectedIndex>0&&(e.selectedIndex--,encodersChanged=!0,e.dispatchEvent(new Event("change")))}function nextEmanator(){const e=document.getElementById("inlet_5_emanator");e.selectedIndex<e.options.length-1&&(e.selectedIndex++,encodersChanged=!0,e.dispatchEvent(new Event("change")))}function autoTransform(){clearTimeout(autoTransformTimeout),clearTimeout(autoPlayTimeout),clearTimeout(autoOSCTimeout);const e=document.getElementById("inlet_5_emanator").value;e>=148&&e<164?(document.getElementById("inlet_1_label").innerText="LFO CC#",document.getElementById("semitone").value<=0&&(document.getElementById("semitone").value=1,midikeys_semitone_or_cc_offset=1)):(document.getElementById("inlet_1_label").innerText="Semitone offset",1==document.getElementById("semitone").value&&(document.getElementById("semitone").value=0,midikeys_semitone_or_cc_offset=0));const t=document.getElementById("rateMs"),i=document.getElementById("tempo");t&&i&&(t._syncListener||(t.addEventListener("input",function(){const e=parseInt(t.value);if(!isNaN(e)&&e>0){let t=Math.round(6e4/e)/2;t<20&&(t=20),t>999&&(t=999),parseInt(i.value)!==t&&(i.value=t)}}),t._syncListener=!0),i._syncListener||(i.addEventListener("input",function(){const e=parseInt(i.value);if(!isNaN(e)&&e>0){let i=Math.round(6e4/e)/2;i<30&&(i=30),i>1500&&(i=1500),parseInt(t.value)!==i&&(t.value=i)}}),i._syncListener=!0)),autoTransformTimeout=setTimeout(()=>{const e=document.getElementById("inputJson").value,t=parseInt(document.getElementById("rateMs").value),i=parseInt(document.getElementById("note").value),o=parseInt(document.getElementById("semitone").value),n=parseInt(document.getElementById("velocity").value),a=parseInt(document.getElementById("enc1").value),l=parseInt(document.getElementById("enc2").value),c=parseInt(document.getElementById("inlet_5_emanator").value);let s;try{s=JSON.parse(e)}catch(e){return document.getElementById("outputJson").value="Invalid JSON input: "+e.message,void clearMidiClip()}try{const e=kasm_rust.kasm_transform_notes(s,t,i,o,n,a,l,c,0,0,0);document.getElementById("outputJson").value=JSON.stringify(e,null,2),drawMidiClip(e)}catch(e){document.getElementById("outputJson").value="Error: "+e.message,clearMidiClip()}},5),clearTimeout(window.updateBangTimeout),window.updateBangTimeout=setTimeout(()=>{updateBang()},50)}function updateBang(){setTimeout(()=>{console.log("kasm: updateBang"),midikeys_note=60,midikeys_velocity=100,run_test_keyboard(),setTimeout(()=>{const e=parseInt(document.getElementById("inlet_5_emanator").value);e>=81&&e<=83&&(document.getElementById("inlet_5_emanator").value="93",document.getElementById("inlet_5_emanator").dispatchEvent(new Event("change")),updateBang())},100)},400)}function send_cc(e,t){clearTimeout(window.sendCC),window.sendCC=setTimeout(()=>{"undefined"!=typeof kasm_rust&&"function"==typeof kasm_rust.send_cc&&(console.log(`kasm: send_cc ${e} value=${t}`),kasm_rust.send_cc(e,t))},100)}function updateDial(e,t,i){const o=parseInt(t);let n,a,l,c;"note"===e&&(updateNoteDisplay(),send_cc(16,t)),"semitone"===e&&(midikeys_semitone_or_cc_offset=t,send_cc(17,t)),"rate"===e?(c=30,l=1500,n=(o-c)/(l-c),send_cc(18,t)):"semitone"===e?(c=-127,l=127,n=(o-c)/(l-c),send_cc(19,t)):"kasm_one"===e||"kasm_two"===e?(c=0,l=127,n=o/127,send_cc(20,t)):(c=0,l=127,n=o/l,send_cc(21,t)),a=270*n-135;const s=2*Math.PI*25,d=s-n*s,r=document.getElementById(e+"-progress");r&&(r.style.strokeDashoffset=d);const u=document.getElementById(e+"-pointer");u&&!isNaN(a)&&u.setAttribute("transform",`rotate(${a} 30 30)`);let m=e;"rate"===e&&(m="rateMs");const y=document.getElementById(m);y&&y.value!=o&&(y.value=o);const v=document.getElementById(e+"-dial");if(v&&v.value!=o){v.value=o;const t=document.getElementById(e);!i&&t&&t.dispatchEvent(new Event("change"))}clearTimeout(window.updateBangTimeout),window.updateBangTimeout=setTimeout(()=>{updateBang()},50)}document.addEventListener("keydown",handleKeyDown),document.addEventListener("keyup",handleKeyUp),document.addEventListener("keydown",function(e){const t=document.activeElement;if(t&&("TEXTAREA"===t.tagName||"INPUT"===t.tagName))return;if(e.ctrlKey||e.altKey||e.metaKey||e.shiftKey)return;const i=e.key.toLowerCase();(keyboardMapping.hasOwnProperty(i)||["z","x","c","v"].includes(i))&&e.preventDefault()}),displayKeyboardHelp(),document.getElementById("transformTest").addEventListener("click",function(){const e=document.getElementById("inputJson").value,t=parseInt(document.getElementById("rateMs").value),i=parseInt(document.getElementById("note").value),o=parseInt(document.getElementById("semitone").value),n=parseInt(document.getElementById("velocity").value),a=parseInt(document.getElementById("enc1").value),l=parseInt(document.getElementById("enc2").value),c=parseInt(document.getElementById("inlet_5_emanator").value);let s;try{s=JSON.parse(e)}catch(e){return void(document.getElementById("outputJson").value="Invalid JSON input: "+e.message)}try{const e=kasm_rust.kasm_transform_notes(s,t,i,o,n,a,l,c);document.getElementById("outputJson").value=JSON.stringify(e,null,2),drawMidiClip(e)}catch(e){document.getElementById("outputJson").value="Error: "+e.message,clearMidiClip()}}),loadbang(initializeApplication);let isDragging=!1,dragStartY=0,dragStartValue=0,currentDragDial=null;function setupDialInteraction(e){const t=document.querySelector(`#${e}-dial`).parentElement;let i=e,o=0,n=127;"rate"===e?(i="rateMs",o=30,n=1500):"semitone"===e?(o=-127,n=127):(o=0,n=127);const a=document.getElementById(i);t.addEventListener("mousedown",t=>startDrag(t,e)),t.addEventListener("touchstart",t=>startDrag(t.touches[0],e)),t.addEventListener("wheel",t=>{encodersChanged=!0,t.preventDefault();const i=parseInt(a.value),l=t.deltaY>0?-1:1;let c=t.shiftKey?.1:1;"rate"===e&&(c=t.shiftKey?5:20);const s=Math.max(o,Math.min(n,i+l*c));updateDial(e,s),autoTransform()}),t.addEventListener("dblclick",function(){let t=0;"rate"===e?t=250:"note"===e?t=60:"semitone"===e?t=0:"velocity"===e||"enc1"===e?t=100:"enc2"===e?t=80:"kasm_one"!==e&&"kasm_two"!==e||(t=64),updateDial(e,t),autoTransform(),document.getElementById("rateMs").dispatchEvent(new Event("input"))}),t.addEventListener("contextmenu",e=>e.preventDefault())}function startDrag(e,t){isDragging||(encodersChanged=!0,isDragging=!0,currentDragDial=t,dragStartY=e.clientY,dragStartValue="rate"===t?parseInt(document.getElementById("rateMs").value):parseInt(document.getElementById(t).value),document.addEventListener("mousemove",handleDrag),document.addEventListener("mouseup",endDrag),document.addEventListener("touchmove",handleTouchDrag),document.addEventListener("touchend",endDrag),document.body.style.userSelect="none",e.preventDefault())}function handleDrag(e){if(!isDragging||!currentDragDial)return;let t=0,i=127;"rate"===currentDragDial?(t=20,i=1500):"semitone"===currentDragDial&&(t=-127,i=127);const o=dragStartY-e.clientY,n=e.shiftKey?.2:.5,a=Math.max(t,Math.min(i,dragStartValue+o*n));updateDial(currentDragDial,Math.round(a)),autoTransform()}function handleTouchDrag(e){if(!isDragging||!currentDragDial)return;e.preventDefault();let t=0,i=127;"rate"===currentDragDial?(t=50,i=1e4):"semitone"===currentDragDial&&(t=-127,i=127);const o=e.touches[0],n=dragStartY-o.clientY,a=Math.max(t,Math.min(i,dragStartValue+.5*n));updateDial(currentDragDial,Math.round(a)),autoTransform()}function endDrag(){isDragging&&("rate"===currentDragDial&&document.getElementById("rateMs").dispatchEvent(new Event("input")),isDragging=!1,currentDragDial=null,document.removeEventListener("mousemove",handleDrag),document.removeEventListener("mouseup",endDrag),document.removeEventListener("touchmove",handleTouchDrag),document.removeEventListener("touchend",endDrag),document.body.style.userSelect="")}function initializeDials(){updateDial("rate",250),updateDial("note",60),updateDial("semitone",0),updateDial("velocity",100),updateDial("enc1",100),updateDial("enc2",80),updateDial("kasm_one",64),updateDial("kasm_two",64),setupDialInteraction("rate"),setupDialInteraction("note"),setupDialInteraction("semitone"),setupDialInteraction("velocity"),setupDialInteraction("enc1"),setupDialInteraction("enc2"),setupDialInteraction("kasm_one"),setupDialInteraction("kasm_two")}function midiToNoteName(e){const t=Math.floor(e/12)-1;return["C","C#","D","Eb","E","F","F#","G","G#","A","Bb","B"][e%12]+t}function noteNameToMidi(e){const t=e.trim().toUpperCase();let i,o;if(2===t.length)i=t[0],o=parseInt(t[1]);else{if(3!==t.length)return null;i=t.substring(0,2),o=parseInt(t[2])}if(isNaN(o)||o<-1||o>9)return null;const n={C:0,"C#":1,D:1,Eb:2,E:3,F:4,"F#":5,G:7,"G#":8,A:9,Bb:10,B:11}[i];if(void 0===n)return null;const a=12*(o+1)+n;return a<0||a>127?null:a}function updateNoteDisplay(){const e=parseInt(document.getElementById("note").value);if(!isNaN(e)&&e>=0&&e<=127){const t=midiToNoteName(e);document.getElementById("noteName").value=t}}function updateNoteFromName(){const e=noteNameToMidi(document.getElementById("noteName").value);null!==e?(document.getElementById("note").value=e,autoTransform()):updateNoteDisplay()}function handleNoteNameKeydown(e){const t=e.key;/^[A-Ga-g#b09]$/.test(t)||"Backspace"===t||"Tab"===t||"Enter"===t||e.preventDefault()}function initializeNoteDisplay(){updateNoteDisplay()}let midiAccess=null,midiOutputs=[],midiInputs=[],playbackTimeouts=[],isPlaying=!1,mpeEnabled=!0,mpeChannels=new Map;async function initializeMIDI(){if(console.log("kasm: Initializing WebMIDI support..."),!navigator.requestMIDIAccess)return console.warn("WebMIDI API not supported in this browser"),void(document.getElementById("playbackStatus").textContent="WebMIDI not supported");try{console.log("kasm: Requesting MIDI access with sysex: false..."),midiAccess=await navigator.requestMIDIAccess({sysex:!1}),console.log("kasm: MIDI access granted successfully"),logMIDIDevices(midiAccess),updateMidiDeviceList(),midiAccess.onstatechange=onMIDIStateChange,console.log("kasm: MIDI system initialized successfully"),document.getElementById("playbackStatus").textContent="MIDI ready"}catch(e){console.error("kasm: Failed to initialize WebMIDI:",e);let t="MIDI access failed";"SecurityError"===e.name?(t="MIDI access blocked by security policy",console.error("kasm: Security Error: MIDI access was blocked. This may be due to browser security settings or HTTPS requirements.")):"NotSupportedError"===e.name?(t="MIDI not supported on this system",console.error("kasm: Not Supported Error: MIDI is not supported on this system or browser.")):"InvalidStateError"===e.name?(t="MIDI system in invalid state",console.error("kasm: Invalid State Error: MIDI system is in an invalid state.")):"AbortError"===e.name&&(t="MIDI access request was aborted",console.error("kasm: Abort Error: MIDI access request was aborted by user or system.")),document.getElementById("playbackStatus").textContent=t}}function logMIDIDevices(e){console.log("kasm: Scanning for MIDI devices...");const t=Array.from(e.inputs.values()),i=Array.from(e.outputs.values());console.log(`kasm: Found ${t.length} MIDI INPUT device(s):`),t.forEach((e,t)=>{console.log(`kasm:   ${t+1}. INPUT: "${e.name}" (${e.manufacturer||"Unknown Manufacturer"})`),console.log(`kasm:      - ID: ${e.id}`),console.log(`kasm:      - State: ${e.state}`),console.log(`kasm:      - Connection: ${e.connection}`),console.log(`kasm:      - Type: ${e.type}`),console.log(`kasm:      - Version: ${e.version||"Unknown"}`)}),console.log(`kasm: Found ${i.length} MIDI OUTPUT device(s):`),i.forEach((e,t)=>{console.log(`kasm:   ${t+1}. OUTPUT: "${e.name}" (${e.manufacturer||"Unknown Manufacturer"})`),console.log(`kasm:      - ID: ${e.id}`),console.log(`kasm:      - State: ${e.state}`),console.log(`kasm:      - Connection: ${e.connection}`),console.log(`kasm:      - Type: ${e.type}`),console.log(`kasm:      - Version: ${e.version||"Unknown"}`)}),0===t.length&&0===i.length?(console.warn("No MIDI devices found. Please connect a MIDI device and refresh the page."),console.log("kasm: Troubleshooting tips:"),console.log("kasm:    - Ensure MIDI device is connected and powered on"),console.log("kasm:    - Try refreshing the page after connecting device"),console.log("kasm:    - Check if device drivers are installed"),console.log("kasm:    - Some devices may require specific browser permissions")):console.log(`kasm: Total MIDI devices found: ${t.length+i.length} (${t.length} inputs, ${i.length} outputs)`)}function onMIDIStateChange(e){const t=e.port,i="input"===t.type,o=i?"INPUT":"OUTPUT";console.log("kasm: MIDI device state change detected:"),console.log(`kasm:    Device: ${o} "${t.name}" (${t.manufacturer||"Unknown"})`),console.log(`kasm:    State: ${t.state}`),console.log(`kasm:    Connection: ${t.connection}`),console.log(`kasm:    ID: ${t.id}`),"connected"===t.state?(console.log(`kasm: MIDI ${o} device connected: "${t.name}"`),i?(console.log(`kasm: Setting up message handler for input device: "${t.name}"`),setupInputMessageHandler(t)):console.log(`kasm: MIDI output device "${t.name}" is now available for playback`),updateMidiDeviceList()):"disconnected"===t.state&&(console.log(`kasm: MIDI ${o} device disconnected: "${t.name}"`),updateMidiDeviceList(),!i&&currentMidiOutput&&currentMidiOutput.id===t.id&&(console.log("kasm: Current MIDI output device was disconnected, clearing selection"),currentMidiOutput=null,document.getElementById("playbackStatus").textContent="Output device disconnected")),midiAccess&&(console.log("kasm: Current MIDI device status after state change:"),logMIDIDevices(midiAccess))}function setupInputMessageHandler(e){e.onmidimessage=function(t){handleMIDIMessage(t,e.name,e.type)},console.log(`kasm: Message handler connected to INPUT device: "${e.name}"`)}function getNoteName(e){const t=Math.floor(e/12)-1;return`${["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]}${t}`}function getCCName(e){return{0:"Bank Select MSB",1:"Modulation Wheel",2:"Breath Controller",4:"Foot Controller",5:"Portamento Time",6:"Data Entry MSB",7:"Channel Volume",8:"Balance",10:"Pan",11:"Expression Controller",12:"Effect Control 1",13:"Effect Control 2",32:"Bank Select LSB",64:"Sustain Pedal",65:"Portamento On/Off",66:"Sostenuto",67:"Soft Pedal",68:"Legato Footswitch",69:"Hold 2",70:"Sound Controller 1",71:"Sound Controller 2",72:"Sound Controller 3",73:"Sound Controller 4",74:"Sound Controller 5",75:"Sound Controller 6",76:"Sound Controller 7",77:"Sound Controller 8",78:"Sound Controller 9",79:"Sound Controller 10",120:"All Sound Off",121:"Reset All Controllers",122:"Local Control On/Off",123:"All Notes Off",124:"Omni Mode Off",125:"Omni Mode On",126:"Mono Mode On",127:"Poly Mode On"}[e]||`CC ${e}`}function updateModwheelUI(e){const t=document.getElementById("modwheel"),i=document.getElementById("modwheel-value");t&&i&&(t.value=e,i.value=e)}function updatePanUI(e){const t=document.getElementById("pan"),i=document.getElementById("pan-value");t&&i&&(t.value=e,i.value=e)}function updateMidiDeviceList(){console.log("kasm: Updating MIDI device list in UI...");const e=document.getElementById("midiOutputSelect"),t=e.value;if(e.innerHTML='<option value="">Select MIDI Device...</option>',midiAccess){const i=Array.from(midiAccess.inputs.values());if(midiOutputs=Array.from(midiAccess.outputs.values()),console.log(`kasm: Populating device list: ${i.length} inputs, ${midiOutputs.length} outputs`),i.forEach((t,i)=>{const o=document.createElement("option");o.value=`input-${i}`,o.disabled=!0,o.style.color="#666",o.style.fontStyle="italic";const n="connected"===t.state?"🟢":"🔴";o.textContent=`${n} INPUT: ${t.name} (${t.manufacturer||"Unknown"}) - ${t.state}`,e.appendChild(o)}),i.length>0&&midiOutputs.length>0){const t=document.createElement("option");t.disabled=!0,t.textContent="────────────────────────────",e.appendChild(t)}midiOutputs.forEach((t,i)=>{const o=document.createElement("option");o.value=i;const n="connected"===t.state?"🟩":"🟥",a="open"===t.connection?"🟩":"🟪";o.textContent=`${n}${a} OUTPUT: ${t.name} (${t.manufacturer||"Unknown"}) - ${t.state}`,"connected"===t.state?(o.style.color="#2e7d32",o.style.fontWeight="bold"):o.style.color="#d32f2f",e.appendChild(o),console.log(`kasm: Added OUTPUT device to list: "${t.name}" (index: ${i}, state: ${t.state})`)});const o=t||window.savedMidiDeviceIndex;o&&""!==o&&midiOutputs[o]&&(e.value=o,currentMidiOutput=midiOutputs[o],selectMidiDevice(),console.log(`kasm: Restored previous device selection: "${currentMidiOutput.name}"`),window.savedMidiDeviceIndex=null);const n=i.length+midiOutputs.length;0===n?(document.getElementById("playbackStatus").textContent="No MIDI devices found",console.log("kasm: No MIDI devices available")):0===midiOutputs.length?(document.getElementById("playbackStatus").textContent=`${i.length} input(s) found, no outputs`,console.log(`kasm: Found ${i.length} input device(s) but no output devices`)):(document.getElementById("playbackStatus").textContent=`${midiOutputs.length} output(s) available`,console.log(`kasm: Device list updated: ${n} total devices (${i.length} inputs, ${midiOutputs.length} outputs)`))}else document.getElementById("playbackStatus").textContent="MIDI not initialized",console.log("kasm: MIDI access not available for device list update")}function selectMidiDevice(){const e=document.getElementById("midiOutputSelect").value;""!==e&&midiOutputs[e]?(currentMidiOutput=midiOutputs[e],document.getElementById("playbackStatus").textContent="ok"):(currentMidiOutput=null,document.getElementById("playbackStatus").textContent="No device selected")}function sendAllNotesOff(e=0){if(!currentMidiOutput)return;const t=[176+e,123,0];currentMidiOutput.send(t);for(let t=0;t<=127;t++)sendNoteOff(t,e)}function processNoteEvent(e,t){midikeys_note=e,midikeys_velocity=t,run_test_keyboard()}function playMidiClip(){if(currentMidiOutput){stopMidiPlayback();try{const e=document.getElementById("outputJson").value,t=JSON.parse(e).notes||[];if(0===t.length)return void(document.getElementById("playbackStatus").textContent="connected");const i=parseInt(document.getElementById("tempo").value)||120,o=parseInt(document.getElementById("midiChannel").value)||0,n=60/i*1e3;isPlaying=!0,document.getElementById("playbackStatus").textContent="...",document.getElementById("playMidi").disabled=!0,t.forEach(e=>{if(1===e.mute)return;if(e.probability<1&&Math.random()>e.probability)return;const t=e.start_time*n,i=e.duration*n;let a=e.velocity;if(e.velocity_deviation>0){const t=(2*Math.random()-1)*e.velocity_deviation;a=Math.max(1,Math.min(127,Math.round(e.velocity+t)))}const l=setTimeout(()=>{isPlaying&&(sendNoteOn(e.pitch,a,o),processNoteEvent(e.pitch,e.velocity))},t);playbackTimeouts.push(l);const c=setTimeout(()=>{isPlaying&&sendNoteOff(e.pitch,o,e.release_velocity||64)},t+i);playbackTimeouts.push(c)});const a=Math.max(...t.map(e=>e.start_time+e.duration)),l=setTimeout(()=>{stopMidiPlayback(),document.getElementById("playbackStatus").textContent=""},a*n+1e3);playbackTimeouts.push(l)}catch(e){console.error("kasm: Error playing MIDI clip:",e),document.getElementById("playbackStatus").textContent="Error playing clip",stopMidiPlayback()}}else document.getElementById("playbackStatus").textContent="No MIDI device selected"}function stopMidiPlayback(){isPlaying=!1,playbackTimeouts.forEach(e=>clearTimeout(e)),playbackTimeouts=[];const e=parseInt(document.getElementById("midiChannel").value)||0;sendAllNotesOff(e),document.getElementById("playMidi").disabled=!1,"Playing..."===document.getElementById("playbackStatus").textContent&&(document.getElementById("playbackStatus").textContent="Stopped")}function saveSettings(){const e={emanator:document.getElementById("inlet_5_emanator").value,midiOutputSelect:document.getElementById("midiOutputSelect").value,midiChannel:document.getElementById("midiChannel").value,tempo:document.getElementById("tempo").value,note:document.getElementById("note").value,semitone:document.getElementById("semitone").value,velocity:document.getElementById("velocity").value,enc1:document.getElementById("enc1").value,enc2:document.getElementById("enc2").value,rateMs:document.getElementById("rateMs").value,exampleSelect:document.getElementById("exampleSelect").value,kasm_one:document.getElementById("kasm_one").value,kasm_two:document.getElementById("kasm_two").value};try{localStorage.setItem("kasmSettings",JSON.stringify(e)),console.log("kasm: Settings saved to localStorage")}catch(e){console.warn("Failed to save settings to localStorage:",e)}}function loadSettings(){try{const e=localStorage.getItem("kasmSettings");if(!e)return!1;const t=JSON.parse(e);return console.log("kasm: Loading settings from localStorage:",t),t.emanator&&(document.getElementById("inlet_5_emanator").value=t.emanator),t.midiChannel&&(document.getElementById("midiChannel").value=t.midiChannel),t.tempo&&(document.getElementById("tempo").value=t.tempo),t.note&&(document.getElementById("note").value=t.note),t.semitone&&(document.getElementById("semitone").value=t.semitone),t.velocity&&(document.getElementById("velocity").value=t.velocity),t.enc1&&(document.getElementById("enc1").value=t.enc1),t.enc2&&(document.getElementById("enc2").value=t.enc2),t.rateMs&&(document.getElementById("rateMs").value=t.rateMs),t.exampleSelect&&(document.getElementById("exampleSelect").value=t.exampleSelect),t.kasm_one&&(document.getElementById("kasm_one").value=t.kasm_one),t.kasm_two&&(document.getElementById("kasm_two").value=t.kasm_two),updateDial("note",t.note||60),updateDial("semitone",t.semitone||0),updateDial("velocity",t.velocity||100),updateDial("enc1",t.enc1||100),updateDial("enc2",t.enc2||80),updateDial("rate",t.rateMs||250),updateDial("kasm_one",t.kasm_one||64),updateDial("kasm_two",t.kasm_two||64),updateNoteDisplay(),t.midiOutputSelect&&setTimeout(()=>{window.savedMidiDeviceIndex=t.midiOutputSelect,updateMidiDeviceList(),document.getElementById("midiOutputSelect").value=t.midiOutputSelect},500),!0}catch(e){return console.warn("Failed to load settings from localStorage:",e),!1}}function clearSettings(){try{localStorage.removeItem("kasmSettings"),console.log("kasm: Settings cleared from localStorage")}catch(e){console.warn("Failed to clear settings from localStorage:",e)}}function updateBang(){setTimeout(()=>{console.log("kasm: updateBang"),midikeys_note=60,midikeys_velocity=100,run_test_keyboard();const e=new KeyboardEvent("keydown",{key:"a",code:"KeyA",keyCode:65,bubbles:!0}),t=new KeyboardEvent("keyup",{key:"a",code:"KeyA",keyCode:65,bubbles:!0});document.dispatchEvent(e),document.dispatchEvent(t),setTimeout(()=>{const e=parseInt(document.getElementById("inlet_5_emanator").value);e>=81&&e<=83&&(document.getElementById("inlet_5_emanator").value="93",document.getElementById("inlet_5_emanator").dispatchEvent(new Event("change")),updateBang())},100)},400)}function autoSaveSettings(){if(encodersChanged=!0,clearTimeout(window.saveSettingsTimeout),window.saveSettingsTimeout=setTimeout(saveSettings,100),"undefined"!=typeof kasm_rust&&kasm_rust.set_emanator){const e=parseInt(document.getElementById("inlet_5_emanator").value);kasm_rust.set_emanator(e)}}function updateMidiClipView(e){try{if(e.includes("Loop recorded:")||e.includes("Playing loop:")||e.includes("Bangaz")||e.includes("loop:")){if("undefined"!=typeof kasm_rust&&kasm_rust.kasm_looper_get_recorded_notes){const e=kasm_rust.kasm_looper_get_recorded_notes();let t;try{t=JSON.parse(e)}catch(i){t=e}const i=convertLooperNotesToMidiClip(t);if((!i.notes||0===i.notes.length)&&"function"==typeof kasm_rust.kasm_pattern_get_notes){const e=kasm_rust.kasm_pattern_get_notes();let t;try{t=JSON.parse(e)}catch(i){t=e}const i=convertLooperNotesToMidiClip(t);return drawMidiClip(i),void(document.getElementById("outputJson").value=JSON.stringify(i,null,2))}drawMidiClip(i),document.getElementById("outputJson").value=JSON.stringify(i,null,2),console.log("kasm: Updated MIDI clip view with looper data:",i)}}else if(e.includes("Pattern")){if("function"==typeof kasm_rust.kasm_pattern_get_notes){const e=kasm_rust.kasm_pattern_get_notes();let t;try{t=JSON.parse(e)}catch(i){t=e}const i=convertLooperNotesToMidiClip(t);return drawMidiClip(i),void(document.getElementById("outputJson").value=JSON.stringify(i,null,2))}console.log("kasm: Pattern looper message:",e)}else console.log("kasm: Looper status:",e.substring(0,40)+(e.length>40?"...":""))}catch(e){console.warn("Error updating MIDI clip view:",e)}}function convertLooperNotesToMidiClip(e){if(!Array.isArray(e)||0===e.length)return{notes:[]};return{notes:e.map((e,t)=>({note_id:t+1,pitch:e.note||60,start_time:(e.time||0)/1e3,duration:(e.dur||500)/1e3,velocity:e.vel||100,mute:0,probability:1,velocity_deviation:0,release_velocity:64}))}}function msg_float(e){"undefined"!=typeof kasm_rust&&kasm_rust.kasm_metronome&&kasm_rust.kasm_metronome(e,0)}document.getElementById("midiOutputSelect").addEventListener("change",()=>{selectMidiDevice(),autoSaveSettings()}),document.getElementById("midiChannel").addEventListener("change",autoSaveSettings),document.getElementById("tempo").addEventListener("change",autoSaveSettings),document.getElementById("refreshMidiDevices").addEventListener("click",updateMidiDeviceList),document.getElementById("playMidi").addEventListener("click",playMidiClip),document.getElementById("stopMidi").addEventListener("click",stopMidiPlayback),document.getElementById("inputJson").addEventListener("input",autoSaveSettings),document.getElementById("inlet_5_emanator").addEventListener("change",autoSaveSettings),document.getElementById("exampleSelect").addEventListener("change",autoSaveSettings),document.getElementById("note").addEventListener("input",autoSaveSettings),document.getElementById("semitone").addEventListener("input",autoSaveSettings),document.getElementById("velocity").addEventListener("input",autoSaveSettings),document.getElementById("enc1").addEventListener("input",autoSaveSettings),document.getElementById("enc2").addEventListener("input",autoSaveSettings),document.getElementById("rateMs").addEventListener("input",autoSaveSettings),document.getElementById("noteName").addEventListener("input",autoSaveSettings),document.getElementById("inlet_5_emanator").addEventListener("change",updateBang),setInterval(function(){"function"==typeof msg_float&&(inlet=6,msg_float(document.getElementById("tempo").value))},10),document.getElementById("inlet_5_emanator").addEventListener("change",function(){if(isRadioButtonSelection)console.log("kasm: Skipping updateBang due to radio button selection");else{document.getElementsByName("emanatorQuick").forEach(e=>e.checked=!1),updateBang()}showPatternPreview()});const modwheelSlider=document.getElementById("modwheel"),modwheelValueBox=document.getElementById("modwheel-value");function sendModwheelCC(e){send_cc(1,e)}modwheelSlider&&modwheelValueBox&&(modwheelSlider.addEventListener("input",function(){modwheelValueBox.value=modwheelSlider.value,sendModwheelCC(parseInt(modwheelSlider.value))}),modwheelValueBox.addEventListener("input",function(){let e=Math.max(0,Math.min(127,parseInt(modwheelValueBox.value)||0));modwheelSlider.value=e,sendModwheelCC(e)}));const panSlider=document.getElementById("pan"),panValueBox=document.getElementById("pan-value");function sendPanCC(e){send_cc(10,e)}function initializePianoKeyboard(){document.querySelectorAll(".piano-key").forEach(e=>{const t=parseInt(e.getAttribute("data-note")),i=e.getAttribute("data-key");e.addEventListener("mousedown",e=>{e.preventDefault(),playPianoKey(t,i)}),e.addEventListener("mouseup",e=>{e.preventDefault(),stopPianoKey(t,i)}),e.addEventListener("touchstart",e=>{e.preventDefault(),playPianoKey(t,i)}),e.addEventListener("touchend",e=>{e.preventDefault(),stopPianoKey(t,i)}),e.addEventListener("mouseenter",()=>{e.classList.contains("white-key")?e.setAttribute("fill","#f0f0f0"):e.setAttribute("fill","#555")}),e.addEventListener("mouseleave",()=>{e.classList.contains("white-key")?e.setAttribute("fill","white"):e.setAttribute("fill","#333")})})}function playPianoKey(e,t){Math.floor(midikeys_semitone_or_cc/12);const i=60+e+midikeys_semitone_or_cc,o=Math.max(0,Math.min(127,i)),n=document.querySelector(`[data-key="${t}"]`);if(n&&(n.classList.contains("white-key")?n.setAttribute("fill","#ddd"):n.setAttribute("fill","#666")),midikeys_note=o,midikeys_velocity=parseInt(document.getElementById("velocity").value)||100,processNoteEvent(midikeys_note,midikeys_velocity),currentMidiOutput){const e=parseInt(document.getElementById("midiChannel").value)||0;sendNoteOn(midikeys_note,midikeys_velocity,e)}}function stopPianoKey(e,t){const i=60+e+midikeys_semitone_or_cc,o=Math.max(0,Math.min(127,i)),n=document.querySelector(`[data-key="${t}"]`);if(n&&(n.classList.contains("white-key")?n.setAttribute("fill","white"):n.setAttribute("fill","#333")),midikeys_note=o,midikeys_velocity=0,run_test_keyboard(),currentMidiOutput){sendNoteOff(o,parseInt(document.getElementById("midiChannel").value)||0)}}panSlider&&panValueBox&&(panSlider.addEventListener("input",function(){panValueBox.value=panSlider.value,sendPanCC(parseInt(panSlider.value))}),panValueBox.addEventListener("input",function(){let e=Math.max(0,Math.min(127,parseInt(panValueBox.value)||64));panSlider.value=e,sendPanCC(e)}));const originalHandleKeyDown=handleKeyDown,originalHandleKeyUp=handleKeyUp;function highlightMidiNoteOnKeyboard(e,t){const i=e%12,o={0:"a",1:"w",2:"s",3:"e",4:"d",5:"f",6:"t",7:"g",8:"y",9:"h",10:"u",11:"j"},n={0:"k",1:"o",2:"l",3:"p",4:";",5:"'",6:"]"};let a=null;const l=e-(60+(parseInt(document.getElementById("semitone").value)||0));if(a=l>=0&&l<=11?o[l]:l>=12&&l<=18?n[l-12]:o[i],a){const e=document.querySelector(`[data-key="${a}"]`);e&&"lime"!==e.getAttribute("fill")&&(t?(e.setAttribute("fill","#ffeb3b"),e.setAttribute("stroke","#fbc02d"),e.setAttribute("stroke-width","2")):e.classList.contains("white-key")?(e.setAttribute("fill","white"),e.setAttribute("stroke","#333"),e.setAttribute("stroke-width","1")):(e.setAttribute("fill","#333"),e.setAttribute("stroke","#000"),e.setAttribute("stroke-width","1")))}}function showPatternPreview(){const e=parseInt(document.getElementById("inlet_5_emanator").value),t=document.getElementById("inlet_5_emanator").options[document.getElementById("inlet_5_emanator").selectedIndex].text;if((t.startsWith("drum:")||t.startsWith("loop:"))&&(console.log("kasm: Showing pattern preview for:",t),"undefined"!=typeof kasm_rust&&"function"==typeof kasm_rust.kasm_pattern_get_notes))try{const i=16,o=parseInt(document.getElementById("velocity").value)||100,n=kasm_rust.kasm_pattern_get_notes(e,i,o);n&&(document.getElementById("outputJson").value=JSON.stringify(n,null,2),drawMidiClip(n),console.log("kasm: Pattern preview updated for:",t))}catch(e){console.error("kasm: Error getting pattern preview:",e)}}handleKeyDown=function(e){const t=e.key.toLowerCase();let i=t;"\\"===t&&(i="y");const o=document.querySelector(`[data-key="${i}"]`);o&&!activeKeys.has(t)&&(o.classList.contains("white-key")?o.setAttribute("fill","#ddd"):o.setAttribute("fill","#666")),originalHandleKeyDown(e)},handleKeyUp=function(e){const t=e.key.toLowerCase();let i=t;"\\"===t&&(i="y");const o=document.querySelector(`[data-key="${i}"]`);o&&(o.classList.contains("white-key")?o.setAttribute("fill","white"):o.setAttribute("fill","#333")),originalHandleKeyUp(e)},window.addEventListener("message",function(e){switch(e.data.type){case"KASM":const t=e.data.args;switch(Object.keys(t).length){case 0:console.log("KJSL: "+e.data.func+" ()"),kasm_rust[e.data.func]();break;case 1:Object.values(t)&&"number"==typeof Object.values(t)[0]&&(console.log("KJSL: "+e.data.func+" ("+Object.values(t)[0]+")"),kasm_rust[e.data.func](Object.values(t)[0]));break;case 2:Object.values(t)&&"number"==typeof Object.values(t)[0]&&"number"==typeof Object.values(t)[1]&&(console.log("KJSL: "+e.data.func+" ("+Object.values(t)[0]+","+Object.values(t)[1]+")"),kasm_rust[e.data.func](Object.values(t)[0],Object.values(t)[1]));break;case 3:Object.values(t)&&"number"==typeof Object.values(t)[0]&&"number"==typeof Object.values(t)[1]&&"number"==typeof Object.values(t)[2]&&(console.log("KJSL: "+e.data.func+" ("+Object.values(t)[0]+","+Object.values(t)[1]+","+Object.values(t)[2]+")"),kasm_rust[e.data.func](Object.values(t)[0],Object.values(t)[1],Object.values(t)[2]))}break;case"BANG":bang();break;case"KASM_KEY":if(e.data.key&&e.data.action){const t={key:e.data.key,code:e.data.code||"",keyCode:e.data.keyCode||e.data.key.charCodeAt(0),bubbles:!0,cancelable:!0};"keydown"===e.data.action?document.dispatchEvent(new KeyboardEvent("keydown",t)):"keyup"===e.data.action&&document.dispatchEvent(new KeyboardEvent("keyup",t))}case"INLET_0_NOTE":inlet=0,msg_int(e.data.value);break;case"INLET_1_SEMITONE":inlet=1,msg_int(e.data.value);break;case"INLET_2_VELOCITY":inlet=2,msg_int(e.data.value);break;case"INLET_3_ENC1":inlet=3,msg_int(e.data.value);break;case"INLET_4_ENC2":inlet=4,msg_int(e.data.value);break;case"INLET_5_EMANATOR":post("KJSL: INLET_5_EMANATOR: "+e.data.value),inlet=5,msg_int(e.data.value);break;case"INLET_6_TEMPO":post("KJSL: INLET_6_TEMPO: "+e.data.value),inlet=6,msg_float(e.data.value);break;case"INLET_7_SHARED1":post("KJSL: INLET_7_SHARED1: "+e.data.value),inlet=7,msg_int(e.data.value);break;case"INLET_8_SHARED2":post("KJSL: INLET_8_SHARED2: "+e.data.value),inlet=8,msg_int(e.data.value)}}),document.getElementById("updateKasmConfig").onclick=function(){const e={smooth_cc:document.getElementById("smooth_cc").value,ignore_scale:document.getElementById("ignore_scale").checked,hand_drums:document.getElementById("hand_drums").checked},t=JSON.stringify(e);console.log("updateKasmConfig: Updating kasm config:",t),kasm_rust.kasm_config(t)},document.getElementById("midiThruCheckbox").addEventListener("change",function(){const e=this.checked;console.log("MIDI Thru:",e);try{"undefined"!=typeof kasm_rust&&"function"==typeof kasm_rust.set_midi_thru_enabled&&kasm_rust.set_midi_thru_enabled(e)}catch(e){console.warn("Failed to call set_midi_thru_enabled on wasm module:",e)}if(e){const e=parseInt(document.getElementById("note").value)||60,t=parseInt(document.getElementById("velocity").value)||100,i=parseInt(document.getElementById("midiChannel").value)||0;sendMidiData([144+i,e,t],e,t),setTimeout(()=>{sendMidiData([128+i,e,0],e,0)},500)}})</script></html>